​<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.2.22</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.2.22</h1>
            <p>
                Mejoras en integridad financiera, observabilidad y estabilidad.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.2.22</p>
            <p><b>Fecha de Despliegue:</b> [Pendiente]</p>
            <p><b>AWS Task:</b> 196</p>
            <p><b>Commits:</b> 7955e9d, 0ce3f7b</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Esta actualización fortalece la fiabilidad del sistema en tres frentes: asegura la integridad de los datos financieros en MercadoPago priorizando el precio base, mejora la observabilidad en PedidosYa mediante el registro de rechazos genéricos, y corrige dependencias faltantes en el módulo de ThirdParty para prevenir errores en tiempo de ejecución.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para api/src/platforms/interfaces/mercadoPago.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/interfaces/mercadoPago.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se modifica la lógica de asignación de precios para priorizar el valor unitario completo sobre el valor unitario ajustado, asegurando que el sistema interno refleje los precios base correctos antes de descuentos o promociones externas.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Corrección en la Asignación de Precio (Full Unit Price)</h5>
                  <p><b>Explicación:</b> Se cambia la propiedad fuente para el precio del detalle (det.price). Anteriormente se usaba <code>unitPrice</code>, que en la API de MercadoPago puede reflejar un precio ya descontado. Ahora se usa <code>fullUnitPrice</code> para capturar el precio de lista original del producto.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Se tomaba el precio unitario que podía incluir descuentos
det.productId = item.externalCode;
det.count = item.quantity;
det.price = item.unitPrice.value ?? 0;
det.promo = 0;
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Se toma el precio completo (base) del ítem
det.productId = item.externalCode;
det.count = item.quantity;
det.price = item.fullUnitPrice.value ?? 0;   //item.unitPrice.value ?? 0;
det.promo = 0;
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Integridad Financiera:</b> Asegura que los precios registrados sean los valores base (fullUnitPrice), eliminando ambigüedades en reportes y cálculos de márgenes causadas por descuentos en la fuente.</p>
                </div>
              </div>
            </details>
            
            <!-- Bloque para api/src/platforms/management/platform/pedidosYa.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/management/platform/pedidosYa.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    En este archivo se mejora la robustez y la observabilidad del flujo de rechazo de órdenes ("Branch Reject"). El cambio refuerza la estructura del código en casos de rechazo por defecto.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Logging y Estructuración en Rechazo Genérico</h5>
                  <p><b>Explicación:</b> Se encapsula la lógica del <code>else</code> (caso de rechazo por defecto cuando no hay un motivo mapeado) en un bloque de código explícito y se añade un log de error (<code>Log.saveError</code>). Esto permite rastrear cuándo y por qué se utilizan los mensajes de rechazo genéricos.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Bloque else implícito sin logging de error
        else
          body = {
            message: 'Hay mucha demanda en el local',//rejectMessageNote,
            reason: 'TOO_BUSY',//rejectMessageNote,
            status: "order_rejected"
          };
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Bloque explícito con logging para trazabilidad
        else {
          body = {
            message: 'Hay mucha demanda en el local',//rejectMessageNote,
            reason: 'TOO_BUSY',//rejectMessageNote,
            status: "order_rejected"
          };
          // Se registra el evento para detectar fallos en el mapeo de rechazos
          Log.saveError(null, { message: 'Error mensaje rechazo', order: order, rejectMessageId: rejectMessageId, rejectMessageNote: rejectMessageNote, platform: 'PedidosYa' });           
        }
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Observabilidad:</b> Transforma un fallo silencioso de mapeo de rechazos en un evento audible mediante logs, facilitando el diagnóstico y mantenimiento.</p>
                </div>
              </div>
            </details>
            
            <!-- Bloque para api/src/platforms/management/platform/thirdParty.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/management/platform/thirdParty.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Este cambio es una corrección técnica (bug fix) para resolver una dependencia faltante. Se añade la importación de un modelo necesario para la lógica de manejo de rechazos.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Importación del Modelo rejectPeyaModel</h5>
                  <p><b>Explicación:</b> Se importa el modelo <code>rejectPeyaModel</code>. La ausencia de esta importación causaría un error si el flujo de ejecución intentara acceder a funcionalidades de rechazo cruzado.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Faltaba la importación del modelo de rechazos de PeYa
import branchModel from '../../../models/branch';
import Log from '../../../utils/log';
import settings from '../../../config/settings';
import orderModel from '../../../models/order';

class ThirdParty extends Platform {
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Se incluye la dependencia necesaria
import branchModel from '../../../models/branch';
import Log from '../../../utils/log';
import settings from '../../../config/settings';
import orderModel from '../../../models/order';
import rejectPeyaModel from '../../../models/rejectPeya'; // Nueva dependencia

class ThirdParty extends Platform {
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Estabilidad:</b> Previene errores de tiempo de ejecución (ReferenceError) al asegurar que todas las dependencias necesarias estén importadas.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
