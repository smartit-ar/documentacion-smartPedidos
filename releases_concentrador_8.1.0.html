<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Concentrador 8.1.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none;
        }

        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Concentrador 8.1.0</h1>
            <p>Habilitación de nuevas integraciones con Smartfran Cloud y MercadoPago Delivery.</p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 8.1.0</p>
            <p><b>Fecha de Despliegue:</b> 2025-09-18</p>
            <p><b>Entorno:</b> Producción & Staging</p>
            <p><b>AWS Task:</b> 214</p>
            <p><b>Commit:</b> 6e7b6ea1443e33c328f095e4d7562c09f0d4f941</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General</h2>
            <p>
               El cambio principal es la adición de las credenciales y configuraciones necesarias para conectar a dos plataformas externas: Smartfran Cloud y MercadoPago Delivery.

Estos cambios no alteran la lógica de negocio actual. Se han añadido parámetros específicos para el flujo de autenticación OAuth 2.0 con Smartfran Cloud y un token estático para MercadoPago Delivery.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>
            <details class="component-card">
                <summary class="component-header">
                    <h3>api/src/config/env/production.js</h3>
                </summary>
                <div class="component-body">
                    <h4>Análisis General</h4>
                    <p>
                        Esta actualización modifica el archivo de configuración del entorno de producción. El propósito principal es añadir las credenciales y parámetros necesarios para que el Concentrador pueda interactuar con dos servicios externos: **Smartfran Cloud** y **MercadoPago Delivery**.
                    </p>
                    <p>
                        Habilita al sistema para que pueda autenticarse y comunicarse con estas nuevas plataformas. La adición del objeto `cloudParams` y el token `MERCADOPAGO_DELIVERY_TOKEN` son los prerrequisitos de configuración necesarios para desarrollar futuras funcionalidades que dependan de la integración con estos servicios.
                    </p>
                    <h4>Cambios Detallados</h4>
                    <h5>1. Adición de `cloudParams`</h5>
                    <p><b>Explicación:</b> Se ha añadido un nuevo objeto de configuración llamado `cloudParams`. Este objeto encapsula la información para que la aplicación se autentique y se comunique con la API de la plataforma "Smartfran Cloud", incluyendo credenciales de tipo OAuth 2.0 y URLs base.</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: El archivo de configuración no contenía parámetros para Smartfran Cloud.
// ...
    SQS: {
      // ...
      mainDeadLetter: {
        NAME: 'https://sqs.us-east-1.amazonaws.com/382381053403/MainDeadLetter.fifo'
      }
    }
  }
};
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se añade el nuevo objeto 'cloudParams' al final de la configuración.
// ...
    SQS: {
      // ...
      mainDeadLetter: {
        NAME: 'https://sqs.us-east-1.amazonaws.com/382381053403/MainDeadLetter.fifo'
      }
    }
  },
  // Se añade un nuevo objeto con toda la configuración para Smartfran Cloud.
  cloudParams: {
    client_id: 'xxx',
    client_secret: 'xxx',
    audience: 'smartfran-cloud-prod',
    url: 'xxx',
    api: 'xxx',
    grant_type: 'client_credentials'
  },
  MERCADOPAGO_DELIVERY_TOKEN: '21f898192cfaa97396629fef5fef3bb5'
};
                    </code></pre>
                    <h5>2. Adición de `MERCADOPAGO_DELIVERY_TOKEN`</h5>
                    <p><b>Explicación:</b> Se ha añadido una nueva clave de configuración que almacena el token de autenticación estático necesario para la API de MercadoPago Delivery.</p>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se añade el token de MercadoPago Delivery.
// ...
  cloudParams: {
    // ...
  },
  // Se añade una nueva clave para el token de MercadoPago Delivery.
  MERCADOPAGO_DELIVERY_TOKEN: 'xxx'
};
                    </code></pre>
                    <div class="analysis-box">
                        <h4>Conclusión del análisis</h4>
                        <p>
                           Centralización de la Configuración: Se mantiene la buena práctica de centralizar todas las credenciales y parámetros de entorno en un único lugar. Estos cambios por sí solos no alteran el comportamiento actual de la aplicación, pero son un prerrequisito indispensable para el desarrollo de las nuevas características.
                        </p>
                    </div>
                </div>
            </details>

            <details class="component-card">
                <summary class="component-header">
                    <h3>api/src/config/env/staging.js</h3>
                </summary>
                <div class="component-body">
                    <h4>Análisis General</h4>
                    <p>
                        Esta actualización modifica el archivo de configuración para el entorno de Staging. El propósito es replicar la estructura de configuración introducida en producción, pero utilizando las credenciales y URLs específicas del ambiente de pre-producción o desarrollo.
                    </p>
                    <h4>Cambios Detallados</h4>
                    <h5>1. Adición de `cloudParams` para Staging</h5>
                    <p><b>Explicación:</b> Se ha añadido un nuevo objeto de configuración `cloudParams` específico para el entorno de Staging. Este objeto contiene las credenciales y URLs para conectarse con las APIs del ambiente de desarrollo/staging de "Smartfran Cloud".</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: El archivo de configuración de Staging no contenía parámetros para Smartfran Cloud.
// ...
    SQS: {
      // ...
      mainDeadLetter: {
        NAME: 'https://sqs.us-east-2.amazonaws.com/382381053403/MainDeadLetter.fifo'
      }
    }
  }
};
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se añade el nuevo objeto 'cloudParams' con las credenciales de Staging.
// ...
    SQS: {
      // ...
      mainDeadLetter: {
        NAME: 'https://sqs.us-east-2.amazonaws.com/382381053403/MainDeadLetter.fifo'
      }
    }
  },
  // Se añade un nuevo objeto con toda la configuración para el ambiente de Staging de Smartfran Cloud.
  cloudParams: {
    client_id: 'xxx',
    client_secret: 'xxx',
    audience: 'xxx',
    url: 'xxx',
    api: 'xxx'
  },
  MERCADOPAGO_DELIVERY_TOKEN: 'xxx'
};
                    </code></pre>
                    <h5>2. Adición de `MERCADOPAGO_DELIVERY_TOKEN`</h5>
                    <p><b>Explicación:</b> Se ha añadido la clave de configuración `MERCADOPAGO_DELIVERY_TOKEN`.</p>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se añade el token de MercadoPago Delivery.
// ...
  cloudParams: {
    // ...
  },
  // Se añade la clave para el token de MercadoPago Delivery.
  MERCADOPAGO_DELIVERY_TOKEN: '21f898192cfaa97396629fef5fef3bb5'
};
                    </code></pre>
                    <div class="analysis-box">
                        <h4>Conclusión del análisis</h4>
                        <p>
                            Asegura que el entorno de Staging tenga la misma estructura de configuración que el de Producción.
                        </p>
                    </div>
                </div>
            </details>

<details class="component-card">
    <summary class="component-header">
        <h3>api/src/controllers/branch.js</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Esta actualización consiste en una serie de cambios menores de formato y limpieza de código en varias funciones del controlador. No introduce ninguna nueva funcionalidad ni altera la lógica de negocio existente. El propósito principal de estos cambios es mejorar la legibilidad y mantener un estilo de código consistente a lo largo del archivo.
        </p>
        <p>
            El impacto funcional de esta actualización es nulo. Las modificaciones se limitan a la indentación, espaciado y la eliminación de líneas en blanco, lo que no afecta el comportamiento del sistema. Es una tarea de mantenimiento de código para asegurar su calidad y facilidad de lectura para los desarrolladores.
        </p>
        <h4>Cambios Detallados</h4>
        <h5>1. Ajustes de formato y limpieza</h5>
        <p><b>Explicación:</b> A lo largo de varias funciones, incluyendo `rejectOrdersPeya`, `sendOpen`, y `updatePlatformsRule`, se han realizado ajustes de formato. Estos cambios incluyen la corrección de la indentación, la eliminación de líneas en blanco innecesarias y la estandarización del espaciado en las llamadas a funciones y la definición de objetos.</p>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: El código presentaba inconsistencias menores en el formato y la indentación.
// ...
             await Promise.allSettled(branchReferences.map(async (store_id) => {
    -          let body = {
                 "status": "ONLINE",
                 "reason": "STORE OPEN"
               };
               const urlAvailability = `${baseUrlUber}/v1/delivery/store/${store_id}/update-store-status`;
    -          try {
    -            await axios.post(urlAvailability, body, headersConfig);
               } catch (error) {
    -            Log.saveError(error, { message: 'Falló envio OPEN uber BO', platform: 'UberEats-Concentrador', urlAvailability: urlAvailability, body: req.body, headersConfig:     headersConfig });
               }
             }));
// ...
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: El formato ha sido corregido para mejorar la legibilidad, sin cambiar la lógica.
// ...
             await Promise.allSettled(branchReferences.map(async (store_id) => {
    +          let body = {
                 "status": "ONLINE",
                 "reason": "STORE OPEN"
               };
               const urlAvailability = `${baseUrlUber}/v1/delivery/store/${store_id}/update-store-status`;
    +          try {
    +            await axios.post(urlAvailability, body, headersConfig);
               } catch (error) {
    +            Log.saveError(error, { message: 'Falló envio OPEN uber BO', platform: 'UberEats-Concentrador', urlAvailability: urlAvailability, body: req.body, headersConfig:     headersConfig });
               }
             }));
// ...
        </code></pre>
        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>
                La modificación en `api/src/controllers/branch.js` es puramente cosmética y de mantenimiento.
            </p>
            <ul>
                <li>Mejorar de la Calidad del Código.</li>
                <li>Sin Impacto Funcional.</li>
            </ul>
        </div>
    </div>
</details>

<details class="component-card">
    <summary class="component-header">
        <h3>api/src/utils/token.js</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Esta actualización, como parte de la iniciativa de Integración de Servicios, introduce un nuevo archivo de utilidades, `token.js`. El propósito de este  componente es encapsular toda la lógica relacionada con la autenticación y la gestión de tokens para la nueva integración con Smartfran Cloud.
        </p>
        <p>
            Este archivo introduce dos funcionalidades:
        </p>
        <ul>
            <li>Gestión de Tokens de Smartfran Cloud: Esto incluye obtener un nuevo token, almacenarlo en memoria y renovarlo automáticamente antes de que expire.</li>
            <li>Utilidad de Desencriptación: Se ha añadido un método estático `decrypt` que proporciona una funcionalidad de desencriptación AES, probablemente para manejar datos sensibles que provienen de la nueva integración.</li>
        </ul>
        <p>
            La creación de este módulo es un paso fundamental para la integración con "Smartfran Cloud", ya que centraliza y abstrae la complejidad del flujo de autenticación OAuth 2.0, proporcionando al resto de la aplicación una forma simple y confiable de obtener un token válido.
        </p>
        <h4>Cambios Detallados</h4>
        <h5>1. Creación de la Clase `Token`</h5>
        <p><b>Explicación:</b> Se ha creado una nueva clase `Token` que actúa como un gestor de tokens. Utiliza propiedades estáticas para almacenar el token (`tokenCloudDef`) y su fecha de expiración (`expires_inDef`), implementando un patrón de Singleton para asegurar que solo haya una instancia del token en toda la aplicación.</p>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se crea un nuevo archivo con la clase Token.
'use strict'
import Log from './log';
import settings from '../config/settings';
import axios from 'axios';
const crypto = require('crypto');

class Token {
    // Se definen propiedades estáticas para almacenar el token y su expiración.
    // Esto permite que el estado del token persista a lo largo del ciclo de vida de la aplicación.
    static Key = '1234567890123456';
    static IV = '6543210987654321';
    constructor() {
        this.tokenSMLDef = '';
        this.tokenCloudDef = '';
        this.expires_inDef = '';
    }

    // ... (métodos estáticos)
}

module.exports = Token;
        </code></pre>

        <h5>2. Lógica de Gestión y Renovación de Tokens</h5>
        <p><b>Explicación:</b> La clase `Token` incluye tres métodos estáticos (`getToken`, `checkAndRenewToken`, `CloudLogin`) que trabajan en conjunto para gestionar el token. El método principal es `getToken`, que primero verifica si el token actual es válido y está a punto de expirar (`checkAndRenewToken`). Si el token no existe o está por vencer, invoca a `CloudLogin` para obtener uno nuevo. Este último método realiza la llamada `POST` al endpoint de autenticación de "Smartfran Cloud" utilizando las credenciales del archivo de configuración.</p>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se añaden los métodos para gestionar el ciclo de vida del token.
// ...
class Token {
// ...
    // Método para verificar si el token necesita ser renovado.
    static async checkAndRenewToken() {
        // Calcula el tiempo restante en segundos para la expiración del token.
        const tiempoRestante = (this.expires_inDef - Date.now()) / 1000;
        // Si no hay token o si expira en menos de 200 segundos, solicita uno nuevo.
        if (!this.tokenSMLDef || tiempoRestante <= 200) {
            await this.CloudLogin();
        }
    }

    // Método que realiza la llamada a la API para obtener un nuevo token.
    static async CloudLogin() {
        try {
            const body = {
                client_id: settings.cloudParams.client_id,
                client_secret: settings.cloudParams.client_secret,
                audience: settings.cloudParams.audience,
                grant_type: settings.cloudParams.grant_type,
            }
            await axios.post(`${settings.cloudParams.url}`, body).then(r => {
                // Almacena el nuevo token en la propiedad estática.
                this.tokenCloudDef = r.data.access_token;
                // Calcula y almacena la nueva fecha de expiración en milisegundos.
                this.expires_inDef = Date.now() + (r.data.expires_in * 1000);
            });
        } catch (error) {
            Log.saveError(error, { message: 'Falló CloudLogin', platform: 'Concetrador' });
        }
    }

    // Método público que el resto de la aplicación usará para obtener un token válido.
    static async getToken() {
        try {
            // Primero, asegura que el token esté vigente.
            await this.checkAndRenewToken();
            // Luego, lo devuelve.
            return this.tokenCloudDef;
        } catch (error) {
            Log.saveError(error, { message: 'Falló getToken', platform: "Concetrador" });
        }
    }
// ...
}
        </code></pre>
        <h5>3. Nueva Utilidad de Desencriptación AES</h5>
        <p><b>Explicación:</b> Se ha añadido un método estático `decrypt` que implementa la desencriptación de texto usando el algoritmo `aes-128-cbc`. Este método toma un texto encriptado en formato Base64 y utiliza una clave (`Key`) y un vector de inicialización (`IV`) fijos para devolver el texto plano. Esta utilidad probablemente se utilizará para procesar información encriptada recibida desde la API de "Smartfran Cloud".</p>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se añade un método de utilidad para la desencriptación.
// ...
class Token {
    // ...

    // Método estático para desencriptar texto.
    static async decrypt(encryptedText) {
        console.log('entró token decrypt', encryptedText);

        if (!encryptedText) {
            throw new Error("Encrypted text is undefined or empty");
        }

        // Se preparan la clave y el vector de inicialización (IV) a partir de constantes.
        const keyBuffer = Buffer.from(this.Key, 'utf-8');
        const ivBuffer = Buffer.from(this.IV, 'utf-8');

        // Se realizan validaciones sobre la longitud de la clave y el IV.
        if (keyBuffer.length !== 16) { /* ... */ }
        if (ivBuffer.length !== 16) { /* ... */ }

        // Se crea el objeto 'decipher' con el algoritmo y las claves.
        const decipher = crypto.createDecipheriv('aes-128-cbc', keyBuffer, ivBuffer);

        // Se realiza la desencriptación.
        let decrypted = decipher.update(encryptedText, 'base64', 'utf-8');
        decrypted += decipher.final('utf-8');

        return decrypted;
    }
}
        </code></pre>
        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>
                La creación del archivo `api/src/utils/token.js` es un paso fundamental para la integración con "Smartfran Cloud".
            </p>
            <ul>
                <li>**Abstracción y Centralización:** Centraliza toda la lógica de autenticación y gestión de tokens en un solo lugar, proporcionando una interfaz simple (`Token.getToken()`) para el resto de la aplicación y ocultando la complejidad del flujo OAuth 2.0.</li>
                <li>**Eficiencia:** Almacena el token en memoria y lo renueva solo cuando es necesario, evitando realizar llamadas de autenticación innecesarias en cada petición a la API de "Cloud".</li>
                <li>**Nuevas Capacidades:** Proporciona una utilidad de desencriptación que será necesaria para manejar los datos provenientes de la nueva integración.</li>
                <li>**Habilitador de Funcionalidad:** Este módulo es un prerrequisito técnico indispensable para poder implementar cualquier funcionalidad que dependa de la comunicación con "Smartfran Cloud".</li>
            </ul>
        </div>
    </div>
</details>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>

</html>
