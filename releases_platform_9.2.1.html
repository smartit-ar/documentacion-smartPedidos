<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.2.1 - Multi-Tenant MercadoPago</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4; /* Añadido un color para la caja de despliegue */
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.2.1 </h1>
            <p>
                Implementación de arquitectura multi-tenant para MercadoPago.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.2.1</p>
            <p><b>Fecha de Despliegue:</b> 2025-10-07</p>
            <p><b>Entorno:</b> [Entorno: Producción/Staging]</p>
            <p><b>AWS Task:</b> 177</p>
            <p><b>Commits:</b> 50eea2fe8dc4cdd9ea14bd5b9cc2b7be5390c58c</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Este release se centra en la refactorización clave del controlador de notificaciones de MercadoPago (`mercadoPago.js`). La principal mejora es la transición de una configuración de un solo cliente a una verdadera arquitectura multi-tenant, donde el `TenantId` se resuelve dinámicamente en tiempo de ejecución. Esto permite al sistema escalar y gestionar múltiples clientes de manera segura y eficiente, basándose en la sucursal que emite la notificación.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado </h2>

            <details class="component-card"
                     >
                <summary class="component-header">
                    <h3>api/src/controllers/mercadoPago.js</h3>
                </summary>
                <div class="component-body">
                    <h4>Análisis General</h4>
                    <p>
                        Este commit refactoriza profundamente el controlador de notificaciones de MercadoPago para integrar un sistema de **tenants dinámicos**. Se abandona el `TenantId` "hardcodeado" y se implementa una lógica que resuelve el tenant correcto en tiempo de ejecución basándose en la sucursal que recibe la notificación.
                        <br>
                        Además, se mejora la lógica de búsqueda de la sucursal para que sea más precisa y se añaden múltiples validaciones para hacer el flujo más robusto. En resumen, esta modificación transforma el controlador de un sistema de un solo cliente a una plataforma **multi-tenant verdadera**.
                    </p>

                    <h4>Cambios Detallados</h4>

                    <h5>1. Importación de la Lista de Tenants</h5>
                    <p><b>Explicación:</b> Se añade la importación de la lista `tenants` desde un nuevo archivo centralizado (`/assets/tenants.js`). Esto permite al controlador acceder a la configuración de todos los tenants del sistema para poder mapearlos dinámicamente.</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: El archivo no importaba la lista de tenants.
// ...
import mongoose from 'mongoose';
import config from '../config/settings';
import Token from '../utils/token';
// ...
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se importa la lista de tenants para poder realizar el mapeo dinámico.
// ...
import mongoose from 'mongoose';
import config from '../config/settings';
import Token from '../utils/token';
import { tenants } from '../assets/tenants';
// ...
                    </code></pre>

                    <h5>2. Cambio en la Lógica de Búsqueda de Sucursal</h5>
                    <p><b>Explicación:</b> La búsqueda de la sucursal (`currentBranch`) se ha movido a una etapa más temprana del proceso y ahora utiliza un criterio de búsqueda más preciso. En lugar de usar la referencia de la tienda (`branchReference`), ahora busca la sucursal que tenga configurado el `mercadoPagoUserId` correspondiente al `user_id` de la notificación.</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: La búsqueda de la sucursal se realizaba más tarde, después de obtener los detalles de la orden,
// y se basaba en 'platforms.branchReference'.
// ...
    let order = MercadoPagoOrder.data;
    let currentBranch = await branchModel.findOne({
      'platforms.platform': new mongoose.Types.ObjectId(mercadoPago.id),
      'platforms.branchReference': order.extension.store.id
    });
    order.branchId = currentBranch.branchId;// ...
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: La búsqueda se realiza antes y utiliza un campo más específico y fiable.
// ...
    if (!mercadoPago) { /* ... */ }

    // DESPUÉS: Se busca la sucursal usando el 'user_id' de MercadoPago como clave.
    let currentBranch = await branchModel.findOne({
      'platforms.platform': new mongoose.Types.ObjectId(mercadoPago.id),
      'platforms.mercadoPagoUserId': user_id
    });

    // DESPUÉS: Se añade una validación para detener el flujo si no se encuentra la sucursal.
    if (!currentBranch) {
      Log.saveError(null, { message: 'Branch not found for given user_id', /*...*/ });
      return res.status(404).json({ message: 'Branch not found for given user_id' });
    }// ...
                    </code></pre>

                    <h5>3. Integración de Resolución Dinámica de Tenant</h5>
                    <p><b>Explicación:</b> Se ha añadido un nuevo bloque de código que utiliza la sucursal encontrada para identificar la cadena a la que pertenece, y luego busca el tenant correspondiente en la lista `tenants`. El `TenantId` obtenido de este proceso se utiliza dinámicamente en las cabeceras de las peticiones a los servicios Cloud.</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: El TenantId estaba "hardcodeado" en las cabeceras de la petición.
// ...
    const headersToken = {
      headers: {
        'Authorization': `Bearer ${tokenAPICloud}`,
        'TraceKey':'1234',
        'TenantId':'d3186bc6d7b2'
      }
    }// ...
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se implementa la lógica para encontrar el tenant dinámicamente.
// ...
    if (!currentBranch) { /* ... */ }

    // Paso 1: Obtener el objeto de la cadena a partir del ID en la sucursal.
    const chainModel = require('../models/chain');
    let chainObj = await chainModel.findById(currentBranch.chain);
    if (!chainObj || !chainObj.chain) { /* ... manejo de error ... */ }

    // Paso 2: Buscar el tenant en la lista usando el nombre de la cadena.
    let tenant = tenants.find(r => r.name === chainObj.chain.toLowerCase());
    if (!tenant) { /* ... manejo de error ... */ }

    // Paso 3: Usar el TenantId dinámico en las cabeceras.
    const headersToken = {
      headers: {
        'Authorization': `Bearer ${tokenAPICloud}`,
        'TraceKey': '1234',
        'TenantId': tenant.tenantId
      }
    }// ...
                    </code></pre>

                    <h5>4. Limpieza de Código</h5>
                    <p><b>Explicación:</b> Se ha eliminado código comentado y se ha mejorado la indentación, lo que resulta en un controlador más limpio y legible.</p>
                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ...
    let order = MercadoPagoOrder.data;
    // console.log('MercadoPago Order:', order);

    let currentBranch = await branchModel.findOne({
      'platforms.platform': new mongoose.Types.ObjectId(mercadoPago.id),
      'platforms.branchReference': order.extension.store.id
    });
    //'platforms.branchReference': order.extension.store.brandId,
    order.branchId = currentBranch.branchId;// ...
                    </code></pre>
                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: El código comentado y la lógica de búsqueda de sucursal antigua han sido eliminados.
// ...
    let order = MercadoPagoOrder.data;

    order.branchId = currentBranch.branchId;// ...
                    </code></pre>

                    <div class="analysis-box">
                        <h4>Conclusión del análisis</h4>
                        <p>La modificación en este controlador representa una evolución hacia un sistema multi-tenant más robusto y dinámico.</p>
                        <p>
                            **Mapeo Preciso:** Al cambiar la lógica de búsqueda de sucursales para usar `mercadoPagoUserId`, se asegura una identificación más precisa y fiable de la tienda que debe procesar la orden.
                            <br>
                            **Escalabilidad Multi-Tenant:** La resolución dinámica del `TenantId` elimina el "hardcodeo" y permite que la aplicación maneje múltiples clientes de manera eficiente y segura, asegurando que cada notificación se procese en el contexto correcto.
                            <br>
                            **Robustez:** Las nuevas validaciones (si la sucursal existe, si la cadena existe, si el tenant existe) hacen que el flujo sea más resistente a errores de configuración.
                        </p>
                    </div>
                </div>
            </details>
          <details class="component-card">
    <summary class="component-header">
        <h3>api/src/models/branch.js</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Este commit realiza una modificación muy puntual pero estructuralmente importante en el esquema de la base de datos para la colección **branches**. Se añade un nuevo campo, **mercadoPagoUserId**, que es el **habilitador clave** para la nueva lógica de búsqueda de sucursales implementada en el controlador de MercadoPago.
        </p>
        <p>
            El objetivo de este cambio es crear un vínculo directo y fiable entre una sucursal en nuestro sistema y su identificador de usuario en la plataforma de MercadoPago.
        </p>

        <h4>Cambios Detallados</h4>

        <h5>1. Adición del Campo mercadoPagoUserId</h5>
        <p><b>Explicación:</b> Se ha añadido un nuevo campo `mercadoPagoUserId` de tipo `Number` al sub-documento `platforms` dentro del `branchSchema`. Este campo está diseñado para almacenar el ID de usuario de MercadoPago (`user_id`) que identifica a una tienda específica en su ecosistema.</p>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: El sub-documento 'platforms' no tenía un campo para el user_id de MercadoPago.
// ...
const branchSchema = new Schema(
  {
    // ...
    platforms: [
      {
        platform: { type: Schema.Types.ObjectId, ref: platformSchema },
        branchReference: { type: String },
        // ...
        StateAPI: { type: Boolean },
        branchName: { type: String },        
        rules: { type: Object }
      }
    ],
    // ...
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se añade el nuevo campo 'mercadoPagoUserId'.
// ...
const branchSchema = new Schema(
  {
    // ...
    platforms: [
      {
        platform: { type: Schema.Types.ObjectId, ref: platformSchema },
        branchReference: { type: String },
        // ...
        StateAPI: { type: Boolean },
        branchName: { type: String },        
        rules: { type: Object },
        mercadoPagoUserId: { type: Number}
      }
    ],
    // ...
        </code></pre>

        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Este cambio en el modelo de datos es la pieza fundamental que permite la refactorización del controlador de MercadoPago.</p>
            <ul>
                <li>**Mapeo Preciso:** Al almacenar el `mercadoPagoUserId` directamente en la configuración de la plataforma para una sucursal, el sistema ahora puede identificar la sucursal correcta de manera inequívoca a partir del `user_id` que llega en las notificaciones de MercadoPago.</li>
                <li>**Eliminación de Ambigüedad:** Esto reemplaza el método anterior que se basaba en `branchReference` (que podría ser un ID de tienda o `store_id`), un campo que podía ser menos consistente o más propenso a errores de configuración.</li>
                <li>**Habilitador de la Lógica Multi-Tenant:** Este cambio es un prerrequisito para que la lógica de resolución dinámica de tenants funcione correctamente, ya que el primer paso de ese flujo es identificar la sucursal correcta.</li>
            </ul>
        </div>
    </div>
</details>

<details class="component-card">
    <summary class="component-header">
        <h3>api/src/platforms/management/platform/mercadoPago.js</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Este commit finaliza la integración del sistema **TENANT** en la clase `MercadoPago`. La lógica de resolución dinámica de tenants, que anteriormente se había implementado en el controlador, ahora se replica dentro de los métodos de esta clase de plataforma (`receiveOrder`, `confirmOrder`, `branchRejectOrder`).
        </p>
        <p>
            El objetivo es asegurar que **todas las interacciones** con los servicios "Cloud" (no solo la notificación inicial) se realicen en el contexto del tenant correcto. Se elimina por completo el `TenantId` "hardcodeado" y se reemplaza por un valor dinámico obtenido a partir de la cadena de la sucursal.
        </p>

        <h4>Cambios Detallados</h4>

        <h5>1. Importación de la Lista de Tenants</h5>
        <p><b>Explicación:</b> Se añade la importación de la lista `tenants` desde el archivo centralizado `/assets/tenants.js`. Esto permite a la clase acceder a la configuración de todos los tenants para poder mapearlos dinámicamente.</p>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: El archivo no importaba la lista de tenants.
// ...
import { head } from 'lodash';
import rejectPeyaModel from '../../../models/rejectPeya';
class MercadoPago extends Platform {
// ...
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se importa la lista de tenants para poder realizar el mapeo dinámico.
// ...
import { head } from 'lodash';
import rejectPeyaModel from '../../../models/rejectPeya';
import { tenants } from '../../../assets/tenants';
class MercadoPago extends Platform {
// ...
        </code></pre>

        <h5>2. Integración de Resolución Dinámica de Tenant en receiveOrder y confirmOrder</h5>
        <p><b>Explicación:</b> La misma lógica de resolución de tenant se ha añadido a los métodos `receiveOrder` y `confirmOrder`. Antes de construir las cabeceras (`headersToken`) para la llamada al servicio Cloud, el código ahora busca la sucursal, obtiene su cadena, encuentra el tenant correspondiente y utiliza su `tenantId`.</p>
        <b>Código Anterior (Ejemplo en receiveOrder):</b>
        <pre><code class="language-javascript">
// ANTES: El TenantId estaba "hardcodeado" en las cabeceras de la petición.
// ...
            if (!mercadoPago) { /* ... */ }

            const headersToken = {
              headers: {
                'Authorization': `Bearer ${tokenAPICloud}`,
                'TraceKey':'1234',
                'TenantId':'d3186bc6d7b2'
              }
            };
// ...
        </code></pre>
        <b>Código Nuevo (Ejemplo en receiveOrder):</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se implementa la lógica para encontrar el tenant dinámicamente.
// ...
            if (!mercadoPago) { /* ... */ }

            // Paso 1: Obtener el objeto de la cadena a partir del ID en la sucursal.
            const chainModel = require('../../../models/chain');
            let chainObj = await chainModel.findById(currentBranch.chain);
            if (!chainObj || !chainObj.chain) { /* ... manejo de error ... */ }

            // Paso 2: Buscar el tenant en la lista usando el nombre de la cadena.
            let tenant = tenants.find(r => r.name === chainObj.chain.toLowerCase());
            if (!tenant) { /* ... manejo de error ... */ }

            // Paso 3: Usar el TenantId dinámico en las cabeceras.
            const headersToken = {
              headers: {
                'Authorization': `Bearer ${tokenAPICloud}`,
                'TraceKey': '1234',
                'TenantId': tenant.tenantId
              }
            };
// ...
        </code></pre>

        <h5>3. Integración de Resolución Dinámica de Tenant en branchRejectOrder</h5>
        <p><b>Explicación:</b> El método `branchRejectOrder` también ha sido refactorizado para incluir la lógica completa de resolución de tenant antes de realizar la llamada para obtener el token de MercadoPago.</p>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: La lógica de resolución de tenant no estaba presente en este método.
// ...
            // Buscar la orden
            const fullOrder = await orderModel.findOne({ 'order.id': order.id });
            const user_id = fullOrder?.order?.merchant?.id;

            if (!user_id) { /* ... */ }

            // Obtener token API Cloud
            const tokenAPICloud = await Token.getToken();
            if (!tokenAPICloud) { /* ... */ }
            
            // ... (se construían los headers con el TenantId hardcodeado)
// ...
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se añade la lógica completa de resolución de tenant.
// ...
            // Buscar la orden
            const fullOrder = await orderModel.findOne({ 'order.id': order.id });
            const user_id = fullOrder?.order?.merchant?.id;
            const currentBranch = await branchModel.findOne({ branchId: order.branchId }).populate("chain");

            if (!user_id) { /* ... */ }

            // Obtener token API Cloud
            const tokenAPICloud = await Token.getToken();
            if (!tokenAPICloud) { /* ... */ }

            // ... (se busca la plataforma)

            // DESPUÉS: Se añade el bloque para encontrar el tenant a partir de la sucursal y la cadena.
            const chainModel = require('../../../models/chain');
            let chainObj = await chainModel.findById(currentBranch.chain);
            if (!chainObj || !chainObj.chain) { /* ... */ }

            let tenant = tenants.find(r => r.name === chainObj.chain.toLowerCase());
            if (!tenant) { /* ... */ }

            // DESPUÉS: Se construyen los headers con el TenantId dinámico.
            const headersToken = {
              headers: {
                'Authorization': `Bearer ${tokenAPICloud}`,
                'TraceKey': '1234',
                'TenantId': tenant.tenantId
              }
            };
            // ... (el resto del flujo continúa)
// ...
        </code></pre>

        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Este commit finaliza la implementación de la lógica multi-tenant en la clase `MercadoPago`.</p>
            <ul>
                <li>**Consistencia:** Al replicar la lógica de resolución de tenant en todos los métodos que interactúan con servicios Cloud (`receiveOrder`, `confirmOrder`, `branchRejectOrder`), se asegura que todas las operaciones se ejecuten consistentemente en el contexto del tenant correcto.</li>
                <li>**Robustez:** La adición de validaciones en cada paso del nuevo flujo (verificar si la cadena existe, si el tenant existe) hace que el código sea más resistente a errores de configuración.</li>
                <li>**Completitud:** Con este cambio, la integración de MercadoPago está completamente adaptada a la nueva arquitectura multi-tenant, permitiendo un aislamiento de datos y una configuración por cliente adecuados.</li>
            </ul>
        </div>
    </div>
</details>
          
          
            </section>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
