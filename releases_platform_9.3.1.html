<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.3.1</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.3.1</h1>
            <p>
                Mejoras en observabilidad, ajustes de reglas de cierre y normalización de SKUs.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.3.1</p>
            <p><b>Fecha de Despliegue:</b> 2025-12-11</p>
            <p><b>AWS Task:</b> 199</p>
            <p><b>Commits:</b> bdf45b1, 38fcae2</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Esta versión introduce mejoras clave en la robustez del sistema. Se ha fortalecido la observabilidad en MercadoPago registrando errores de tokens en la nube. Se ajustaron las reglas de negocio para permitir rechazos automáticos por "local cerrado" en la plataforma ID 8. Adicionalmente, se refinó la integración de PedidosYa mediante la normalización de SKUs (eliminación de sufijos) y limpieza de código legado.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para api/src/controllers/mercadoPago.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/controllers/mercadoPago.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se instrumentaliza la captura de fallos en la obtención de tokens de autenticación externos (Cloud), asegurando que estos eventos queden registrados en el sistema de logs centralizado antes de devolver una respuesta de error al cliente.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Registro de Errores en Obtención de Token Cloud</h5>
                  <p><b>Explicación:</b> Se añade una llamada explícita a <code>Log.saveError</code> dentro del bloque catch que maneja la solicitud del token. Anteriormente, el error 500 se devolvía sin persistir el detalle, dificultando el debugging.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Se retornaba el error 500 sin dejar registro en el sistema de logs
    try {
      tokenMercadoPagoCloud = await axios.get(urlTokenMercadoPagoCloud, headersToken);
    } catch (err) {
      return res.status(500).json({ message: 'Error fetching token from Cloud', details: err.response?.data || err.message });
    }
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Se registra el error antes de responder, facilitando el debugging
    try {
      tokenMercadoPagoCloud = await axios.get(urlTokenMercadoPagoCloud, headersToken);
    } catch (err) {
      // Nueva línea para persistir el error
      Log.saveError(null,{message: 'Error fetching token from Cloud', details:err.response?.data || err.message});
      return res.status(500).json({ message: 'Error fetching token from Cloud', details: err.response?.data || err.message });
    }
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Mejora en Debugging:</b> Elimina un punto ciego en el monitoreo al asegurar que los fallos de autenticación con la nube de MP sean auditables.</p>
                </div>
              </div>
            </details>
            
            <!-- Bloque para api/src/platforms/management/platform.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/management/platform.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se modifica la lista de control (allowlist) para incluir una plataforma adicional bajo las reglas de gestión automática de "local cerrado".
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Inclusión de Plataforma ID 8 en Reglas de Cierre</h5>
                  <p><b>Explicación:</b> Se agrega el ID 8 al array <code>plarforms22</code>. Esto habilita que las órdenes de esta plataforma sean rechazadas automáticamente con el motivo "local cerrado" en el momento de la recepción si corresponde.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: La plataforma 8 no estaba incluida en la lógica de rechazo por cierre
// platform: si no está en el array la orden se rechaza por local cerrado en el momento
let plarforms22 = [1, 2, 4, 7, 11, 12];
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Se habilita la plataforma 8 para este comportamiento
// platform: si no está en el array la orden se rechaza por local cerrado en el momento
let plarforms22 = [1, 2, 4, 7, 8, 11, 12];
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Homologación:</b> Iguala el comportamiento de la plataforma ID 8 con el resto de las integraciones principales respecto al manejo de rechazos automáticos.</p>
                </div>
              </div>
            </details>
            
            <!-- Bloque para api/src/platforms/interfaces/pedidosYa.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/interfaces/pedidosYa.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Refinamiento del parser genérico para asegurar la compatibilidad con el sistema POS mediante la normalización de códigos de producto y la limpieza de código legado.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Normalización de SKUs (Sanitización de remoteCode)</h5>
                  <p><b>Explicación:</b> Se añade una lógica de limpieza para el campo <code>remoteCode</code>. Si el código recibido contiene un guion (-), el sistema recorta el string y conserva solo la parte anterior (ID base), descartando sufijos de variantes.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Se tomaba el remoteCode tal cual venía de la API
  for (let detail of order.products) {
    let det = {};        
    if (detail.name.trim().toLowerCase().startsWith('promo')) {
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Se verifica y limpia el código antes de procesarlo
  for (let detail of order.products) {
    let det = {};        
    // Lógica añadida para quitar sufijos después del guion
    if(detail.remoteCode?.includes("-"))
      detail.remoteCode = detail.remoteCode?.split("-")[0];
    
    if (detail.name.trim().toLowerCase().startsWith('promo')) {
                  </code></pre>
            
                  <h5>Limpieza de Código Muerto (Cleanup)</h5>
                  <p><b>Explicación:</b> Se eliminó un bloque extenso de código comentado que contenía la lógica antigua de mapeo, mejorando la legibilidad del archivo.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Bloque de código comentado obsoleto
      det.includedItems = subitems;
      details.push(det);
/*
      let detHeader = {};
      detHeader.productId = detail.id;
      // ... (múltiples líneas de lógica antigua) ...
      numberOfPromotions += 1;*/
    } else {
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: El bloque comentado ha sido removido completamente
      det.includedItems = subitems;
      details.push(det);
    } else {
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Robustez:</b> Previene fallos de enlace de productos ("Product Not Found") al estandarizar el formato del SKU.<br>
                  <b>Calidad:</b> Reduce la deuda técnica eliminando código obsoleto.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
