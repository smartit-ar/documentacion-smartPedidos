<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Release Técnico: Concentrador 7.3.0</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

    :root {
      --bg-color: #f4f7f9;
      --card-bg-color: #ffffff;
      --text-color: #212529;
      --text-muted-color: #6c757d;
      --border-color: #dee2e6;
      --primary-color: #0056b3;
      --analysis-bg: #e6f7ff;
      --analysis-border: #91d5ff;
      --deployment-bg: #f0fdf4;
      --deployment-border: #86efac;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 2em;
      line-height: 1.7;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
    }
    
    .main-header {
      background-color: var(--card-bg-color);
      padding: 2em;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 2.5em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .main-header h1 {
      margin: 0 0 0.25em 0;
      font-size: 2.2em;
      color: var(--primary-color);
    }
    
    .main-header p {
      margin: 0;
      font-size: 1.1em;
      color: var(--text-muted-color);
    }

    .deployment-info-box {
      background-color: var(--deployment-bg);
      border-left: 4px solid var(--deployment-border);
      padding: 1em 1.5em;
      margin-bottom: 2.5em;
      border-radius: 4px;
    }
    .deployment-info-box h4 {
      margin-top: 0;
      font-size: 1.2em;
      color: #166534;
    }
    .deployment-info-box p {
      margin: 0.5em 0 0 0;
      font-family: 'Fira Code', monospace;
      font-size: 0.95em;
    }

    .service-section {
        margin-bottom: 3em;
    }

    .service-section > h2 {
        font-size: 1.8em;
        color: var(--primary-color);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5em;
        margin-bottom: 1.5em;
    }
    
    .component-card {
      background-color: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 2em;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .component-header {
      padding: 1em 1.5em;
      background-color: #fafafa;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      list-style: none;
    }

    .component-header::-webkit-details-marker {
      display: none;
    }
    
    .component-header h3 {
      margin: 0;
      font-family: 'Fira Code', monospace;
      font-size: 1.2em;
    }

    .component-body {
      padding: 1.5em;
    }

    .component-body h4 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-size: 1.2em;
        color: #343a40;
    }
    
    .component-body h5 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-size: 1.1em;
        font-weight: 700;
    }
    
    .analysis-box {
      background-color: var(--analysis-bg);
      border-left: 4px solid var(--analysis-border);
      padding: 1em 1.5em;
      margin-top: 1.5em;
      border-radius: 4px;
    }
    
    .analysis-box h4 {
      margin-top: 0;
      font-size: 1.1em;
      color: var(--primary-color);
    }

    pre[class*="language-"] {
      padding: 1.2em !important;
      margin: 1em 0 !important;
      border-radius: 6px;
      font-family: 'Fira Code', monospace !important;
      font-size: 0.9em !important;
      line-height: 1.5 !important;
      border: 1px solid var(--border-color);
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>

<body>

  <div class="container">
    <header class="main-header">
      <h1>Notas de Release: Concentrador 7.3.0</h1>
      <p>Ampliar envío de estado de tiendas (Open/Close) a PedidosYa para múltiples países</p>
    </header>

    <div class="deployment-info-box">
        <h4>Información de Despligue</h4>
        <p><b>Versión:</b> 7.3.0</p>
        <p><b>Fecha de Despliegue:</b> 2025-09-01</p>
        <p><b>Entorno:</b> Prduccion</p>
        <p><b>AWS TASK:</b> 197</p>
        <p><b>COMMIT:</b> c0c736913a3912fd71658ac501638eb47dde6ceb</p>
    </div>

    <section id="summary" class="service-section">
        <h2>Resumen General</h2>
        <p>
            
El sistema de sincronización de estado de tiendas con PedidosYa, que se ejecuta en horarios específicos (10:02 hs-10:32 hs-11:02 hs-11:32 hs-12:02 hs-23:02 hs), estaba limitado a operar únicamente para sucursales en Argentina. Ahora se mediantes estos cambios se propone la expansión de la funcionalidad a Uruguay, Chile, Paraguay y Perú.

        </p>
    </section>

    <section id="service-one" class="service-section">
      <h2>Análisis Técnico Detallado</h2>
      
   <details class="component-card">
  <summary class="component-header">
    <h3>api/src/controllers/branch.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
        Esta actualización, como parte de la iniciativa de <b>Automatizacion Open/Close de PedidosYa</b>, es que opere en múltiples países, respetando sus respectivas zonas horarias. Anteriormente, esta lógica estaba codificada de forma estática para funcionar únicamente en Argentina.
      </p>
      <p>
        El cambio principal consiste en una modificacion en (<code>cronPeya</code>). Se ha eliminado la lógica de horarios fijos en UTC y se ha reemplazado por un sistema dinámico que lee los países y sus zonas horarias desde la base de datos. A partir de esta información, genera planificaciones de ejecución personalizadas para cada región, asegurando que las operaciones de sincronización ocurran en los horarios locales requeridos.
      </p>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Dinamización de Crons</h5>
      <p><b>Explicación:</b> La nueva lógica consulta la base de datos para obtener todos los países, itera sobre ellos, y para cada uno, utiliza una nueva función <code>toUTC</code> para convertir los horarios locales a la hora UTC correcta según la zona horaria (tzo) del país.</p>
      <b>Código Anterior:</b>
      <pre><code class="language-javascript">
// ANTES: Los horarios estaban fijos en UTC, calculados manualmente solo para la zona horaria de Argentina.
async function cronPeya(baseUrl) {
  // ...
  // 23:02 AR → 02:02 UTC // 10:02 → 13:02 // 10:32 AR → 13:32 UTC // 11:02 AR → 14:02 UTC // 11:32 AR → 14:32 UTC // 12:02 AR → 15:02 UTC
  cron.schedule('2 2,13,14,15 * * *', async () => await enviarEstadoPedidosYa());
  cron.schedule('32 13,14 * * *', async () => await enviarEstadoPedidosYa());
  // 11:16 AR → 14:16 UTC
  cron.schedule('16 14 * * *', async () => await enviarEstadoRappi());
}
      </code></pre>
      <b>Código Nuevo:</b>
      <pre><code class="language-javascript">
// DESPUÉS: El planificador es ahora dinámico y multi-región.
async function cronPeya(baseUrl) {
  // ... (otros crons que no dependen de la hora local)

  // Se definen los horarios locales de referencia requeridos por el ticket.
  const pedidosYaTimes = [
    { hour: 23, minute: 2 }, { hour: 10, minute: 2 }, { hour: 10, minute: 32 },
    { hour: 11, minute: 2 }, { hour: 11, minute: 32 }, { hour: 12, minute: 2 },
  ];
  const rappiTimes = [ { hour: 11, minute: 16 } ];

  // Se obtienen todos los países y sus zonas horarias de la base de datos.
  let countries = await countryModel.find({});
  // Se itera sobre cada país para crear planificaciones personalizadas.
  for (const country of countries) {
    const tzo = parseFloat(country.tzo); // Se obtiene la zona horaria (ej. -3).

    // Se crean los crons para PedidosYa para el país actual.
    for (const pedidosYaTime of pedidosYaTimes) {
      // Se convierte la hora local a UTC usando la nueva función 'toUTC'.
      const { hour: h, minute: m } = toUTC(pedidosYaTime.hour, pedidosYaTime.minute, tzo);
      const cronExp = `${m} ${h} * * *`; // Se genera la expresión cron en UTC.
      // Se planifica la tarea, pasando el nombre del país como parámetro.
      cron.schedule(cronExp, async () => await enviarEstadoPedidosYa(country.country));
    }
    
    // Se crean los crons para Rappi (lógica idéntica).
    for (const rappiTime of rappiTimes) {
      const { hour: h, minute: m } = toUTC(rappiTime.hour, rappiTime.minute, tzo);
      const cronExp = `${m} ${h} * * *`;    
      cron.schedule(cronExp, async () => await enviarEstadoRappi(country.country));
    }
  }
}

// Nueva función helper para la conversión de zona horaria.
function toUTC(localHour, localMinute, tzo) {
  // Calcula la hora UTC. El '+ 24' y el módulo '%' manejan correctamente los cruces de día.
  let utcHour = (localHour - tzo + 24) % 24;
  return { hour: utcHour, minute: localMinute };
}
      </code></pre>

      <h5>2. Adaptación de Lógica para Múltiples Países</h5>
      <p><b>Explicación:</b> Las funciones <code>enviarEstadoRappi</code> y <code>enviarEstadoPedidosYa</code> fueron modificadas para aceptar un parámetro <code>country</code>. Este cambio permite que las funciones filtren las sucursales y utilicen las credenciales correctas para el país que se está procesando.</p>
      <b>Código Anterior:</b>
      <pre><code class="language-javascript">
// ANTES: La función operaba sobre un conjunto fijo de sucursales (Argentina) y el log era genérico.
async function enviarEstadoPedidosYa() {
  // ...
  let branchesToOpen = await model.find({
    "address.country": "Argentina",
    // ...
  });
  // ...
  await openClosedLogModel.create({
    Ident: "PedidosYaCRON",
    // ...
  });
}
      </code></pre>
      <b>Código Nuevo:</b>
      <pre><code class="language-javascript">
// DESPUÉS: La función es ahora genérica y opera sobre el país que recibe como parámetro.
async function enviarEstadoPedidosYa(country) {
  // ...
  let branchesToOpen = await model.find({
    // El filtro de país ahora es dinámico, basado en el parámetro de entrada.
    "address.country": country,
    // ...
  });
  // ...
  await openClosedLogModel.create({
    // El identificador del log ahora incluye el país para una mejor trazabilidad.
    Ident: "PedidosYaCRON " + country,
    // ...
  });
}
      </code></pre>

      <h5>3. Mejoras en la Creación de Logs</h5>
      <p><b>Explicación:</b> En las funciones <code>checkOfflinePOSuber</code> y <code>checkOfflinePOSpeya</code>, se añadió una comprobación <code>if(extraData.length > 0)</code> antes de crear el registro de log. Esto previene la creación de logs vacíos si la tarea se ejecuta pero no encuentra ninguna sucursal que necesite un cambio de estado.</p>
      <b>Código Anterior:</b>
      <pre><code class="language-javascript">
// ANTES: El log se creaba incondicionalmente, incluso si 'extraData' estaba vacío.
// ...
    await Promise.allSettled([...closePromises, ...openPromises]);
    await openClosedLogModel.create({
      result: !extraData.some(branch => 
        branch.results.some(r => r.result === false)
      ),
      // ...
    });
// ...
      </code></pre>
      <b>Código Nuevo:</b>
      <pre><code class="language-javascript">
// DESPUÉS: El log solo se crea si hay datos que registrar.
// ...
    await Promise.allSettled([...closePromises, ...openPromises]);
    // Se añade esta condición para evitar la creación de logs vacíos.
    if(extraData.length > 0)
    await openClosedLogModel.create({
      result: !extraData.some(branch => 
        branch.results.some(r => r.result === false)
      ),
      // ...
    });
// ...
      </code></pre>

      <h5>4. Refactorización del Manejo de Errores</h5>
      <p><b>Explicación:</b> En la función <code>rejectOrdersPeya</code>, se ajustó el alcance del bloque <code>try-catch</code> para que envuelva todo el bucle <code>for</code>.</p>
      <b>Código Anterior:</b>
      <pre><code class="language-javascript">
// ANTES: El bloque try-catch estaba dentro del bucle 'for'.
async function rejectOrdersPeya() {
  let rejects = await rejectPeyaModel.find({send: false});
  for (const reject of rejects) {
    try {
      // ... lógica de switch ...
    } catch (error) {
      // ... manejo de error ...
    }
  }
}
      </code></pre>
      <b>Código Nuevo:</b>
      <pre><code class="language-javascript">
// DESPUÉS: El bloque try-catch ahora envuelve toda la lógica de la función.
async function rejectOrdersPeya() {
  try {
    let rejects = await rejectPeyaModel.find({send: false});
    for (const reject of rejects) {
      // ... lógica de switch ...
    }
  } catch (error) {
    // ... manejo de error ...
  }
}
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <ul>
          <li><b>Escalabilidad:</b> El sistema ya no está limitado a Argentina. La dinamización de los cron jobs permite que el sistema escale a nuevos países y zonas horarias sin necesidad de modificar el código.</li>
          <li><b>Precisión Horaria:</b> Las operaciones de sincronización se ejecutan en los horarios locales correctos para cada país (Tzo).</li>
      </ul>
    </div>
  </div>
</details>

    </section>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
