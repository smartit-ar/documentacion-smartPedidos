<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.3.0</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.3.0</h1>
            <p>
                Refactorización y generalización del parser de órdenes de PedidosYa.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.3.0</p>
            <p><b>Fecha de Despliegue:</b> 2025-12-11</p>
            <p><b>AWS Task:</b> 198</p>
            <p><b>Commits:</b> 7b9911d5a6fa8d84a98d1e9bd862037a5ba9d918</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Esta actualización introduce una refactorización mayor en el mecanismo de interpretación (parsing) de órdenes entrantes de PedidosYa. El objetivo principal es transicionar de un mapeo específico para un cliente hacia un mapeo genérico y estructurado que pueda ser utilizado por defecto para cualquier nuevo tenant, aislando la lógica legacy únicamente para el cliente "Grido".
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para api/src/platforms/interfaces/pedidosYa.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/interfaces/pedidosYa.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se moderniza la estructura de datos resultante del mapeo de órdenes: en lugar de una lista plana con strings concatenados, se adopta una estructura jerárquica que distingue explícitamente entre <code>COMBO</code> (con <code>includedItems</code>) y <code>PRODUCT</code> (con <code>customizations</code>).
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Generalización y Reestructuración del Mapper</h5>
                  <p><b>Explicación:</b> Se renombra y reescribe la función de mapeo. La nueva implementación construye objetos anidados, mejorando la semántica de los datos (separando extras, componentes removidos y sub-items de combos) en lugar de depender de concatenación de texto.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Función específica y lógica plana (concatenación de strings y groupIds)
function detailsMapperParseLodejacinto(order) {
  let details = [];
  let numberOfPromotions = 1;
  // ... lógica compleja de strings y validationSKU ...
      detHeader.groupId = numberOfPromotions;
      // ...
      optionsString += ' ' + option.name + ' X ' + option.quantity;
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Función genérica y estructura jerárquica (Objetos anidados)
function detailsMapperParseOther(order) {
  let details = [];
  for (let detail of order.products) {
    let det = {};        
    if (detail.name.trim().toLowerCase().startsWith('promo')) { // Detección de Combos
      det.itemType = "COMBO";
      det.includedItems = subitems; // Array de sub-items anidados
      // ...
    } else {
      det.itemType = "PRODUCT";
      det.customizations = {
        observation: detail.comment,
        removedComponents: removedComponents, // Array de componentes quitados
        extras: extras // Array de agregados
      }
      // ...
    }
  }
  return details; 
}
                  </code></pre>
            
                  <h5>Inversión de la Estrategia de Selección de Mapper</h5>
                  <p><b>Explicación:</b> Se modifica la lógica que decide qué función de mapeo utilizar. "Grido" se convierte en la excepción (manteniendo su lógica legacy) y cualquier otro tenant utilizará por defecto el nuevo parser genérico <code>detailsMapperParseOther</code>.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-javascript">
// ANTES: Lodejacinto era la excepción, Grido el default
              if(tenant.name === "lodejacinto") 
                details = detailsMapperParseLodejacinto(order);
              else
                details = detailsMapperParseGrido(order);
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Grido es la excepción, el nuevo parser es el default para todos los demás
              if(tenant.name === "grido") 
                details = detailsMapperParseGrido(order);
              else
                details = detailsMapperParseOther(order);
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Escalabilidad:</b> El sistema ahora acepta nuevos tenants sin configuración adicional de código.<br>
                  <b>Calidad de Datos:</b> La estructura rica (itemType, customizations) reduce errores operativos en Cocina.<br>
                  <b>Mantenibilidad:</b> Se aisla el código legacy de Grido, protegiendo al resto de la plataforma.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
