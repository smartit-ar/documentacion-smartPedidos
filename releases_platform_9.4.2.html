<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.4.2 - Gestión Avanzada de Combos</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.4.2</h1>
            <p>
                Gestión avanzada de Combos y lógica de parsing de órdenes para PedidosYa.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.4.2</p>
            <p><b>Fecha de Despliegue:</b> 13/01/2026</p>
            <p><b>AWS Task:</b> 203</p>
            <p><b>Commits:</b> 94e9fa01082c545aea37b03f19826c7796ba3f78</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Esta actualización se centra en perfeccionar la lógica de interpretación de órdenes complejas (Combos) provenientes de PedidosYa. Se expanden los criterios para detectar qué es un "Combo", se implementa una lógica avanzada para asociar extras y modificaciones a componentes específicos dentro del combo (usando una sintaxis de SKU especial), y se corrige el cálculo del precio total sumando los costos de los componentes individuales.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para api/src/platforms/interfaces/pedidosYa.js -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>api/src/platforms/interfaces/pedidosYa.js</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Se introducen mejoras significativas en el mapeo de órdenes para soportar menús complejos. Se abarcan cuatro áreas clave: detección de combos ampliada, parsing de SKUs para vinculación padre-hijo, detección semántica de ingredientes removidos y acumulación precisa de precios.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Expansión de Criterios de Detección de Combos</h5>
                  <p><b>Explicación:</b> Se amplía la condición para clasificar un ítem como <code>COMBO</code>. Además de "promo", ahora se aceptan explícitamente "combo" y "hamburguesa" (con espacio). Esto permite manejar menús donde el ítem principal actúa como contenedor.</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Mayor cobertura de casos de uso para combos
    if (detail.name.trim().toLowerCase().startsWith('promo') || 
          detail.name.trim().toLowerCase().startsWith('combo') ||
          detail.name.trim().toLowerCase().startsWith('hamburguesa ')
    ) {
                  </code></pre>
            
                  <h5>Mapeo Avanzado de Extras y Remociones en Sub-ítems</h5>
                  <p><b>Explicación:</b> Se introduce lógica para parsear el <code>remoteCode</code>. Si contiene un <code>+</code>, se separa el código del componente padre. Esto permite inyectar extras (identificados con "E") directamente en el array <code>customizations.extras</code> del sub-ítem correspondiente, en lugar de asignarlos al combo general.</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Lógica de vinculación padre-hijo basada en SKU
        if(extraRemove.remoteCode.slice(-1) === "E")
          subitems.find(r => r.sku === extraRemove.remoteCode.split('+')[1].slice(0, -1)).customizations.extras.push({ ... })
                  </code></pre>

                  <h5>Identificación de Componentes Removidos ("Sin")</h5>
                  <p><b>Explicación:</b> Para ítems individuales, se mejora la detección de ingredientes removidos mediante análisis semántico. Si el nombre de la opción comienza con "Sin", se añade a la lista de componentes removidos.</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Detección semántica de remociones
          if(option.name.trim().toLowerCase().startsWith('sin'))
            removedComponents.push(subItem);
                  </code></pre>

                  <h5>Acumulación de Precios en Combos</h5>
                  <p><b>Explicación:</b> Se introduce la variable <code>acumPrice</code> para sumar el costo de cada componente individual dentro del combo. Al final, este acumulado se suma al precio base del combo (<code>det.price</code>), asegurando integridad financiera.</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-javascript">
// DESPUÉS: Suma de precios de componentes al total
          }else{
            acumPrice +=  parseFloat(option.price);
            // ... agregar subitem ...
          }
      // ...
      det.price +=  parseFloat(acumPrice);
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Precisión Operativa:</b> El sistema ahora asigna correctamente los modificadores a sus componentes específicos (ej. queso a la hamburguesa, no al combo), mejorando la claridad en cocina.<br>
                  <b>Integridad Financiera:</b> La suma explícita de precios evita pérdidas por cobros de upgrades no contabilizados.<br>
                  <b>Flexibilidad:</b> Adaptabilidad a diferentes estructuras de menú en PedidosYa.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
