<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Platform 9.0.0</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none;
        }

        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Platform 9.0.0</h1>
            <p>Implementación de la nueva arquitectura de gestión de parámetros (TENANT) y refactorización de la lógica de orden de pedidos.</p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 9.0.0</p>
            <p><b>Fecha de Despliegue:</b> 2025-09-10</p>
            <p><b>Entorno:</b> Producción</p>
            <p><b>AWS Task:</b> 172 y 173</p>
            <p><b>Commits:</b> 7a991c42, 0fb16915, 8c391352, 9b3f4c29, e7e0646e</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General</h2>
            <p>
                Este release marca un hito importante con la implementación de la nueva arquitectura **TENANT**. Se introduce un sistema centralizado para la gestión de parámetros de configuración de plataformas, eliminando la lógica distribuida y dependiente de archivos locales. Además, se refactoriza significativamente la clase `ThirdParty` para soportar un flujo de trabajo más inteligente, incluyendo la auto-aceptación de pedidos basada en reglas dinámicas, y se mejora la robustez del manejo de errores en todo el sistema.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

          <details class="component-card">
  <summary class="component-header">
    <h3>api/src/controllers/peya.js</h3>
  </summary>
        <div class="component-body">
            <h4>Análisis General</h4>
            <p>
                Los cambios en este controlador se centran en dos áreas principales:<br>
                <b>Modificación de la Lógica de Negocio:</b> Se ha deshabilitado la funcionalidad que rechazaba automáticamente una orden de PedidosYa cuando el sistema detectaba que el restaurante estaba cerrado. La nueva política es confirmar la recepción del webhook a PedidosYa en todos los casos, dejando la gestión del rechazo a otro proceso.<br>
            </p>
            
            <h4>Cambios Detallados</h4>

            <h5>1. Eliminación de Dependencia del Modelo</h5>
            <p><b>Explicación:</b> El modelo <code>rejectPeyaModel</code> se utilizaba para registrar las URLs de rechazo de PedidosYa que fallaban, para poder reintentarlas posteriormente. Dado que la lógica de rechazo automático en este punto del flujo ha sido eliminada, la importación y el uso de este modelo ya no son necesarios en este archivo.</p>
            <b>Código Anterior:</b>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> settings <span class="token keyword">from</span> <span class="token string">'../config/settings'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branch <span class="token keyword">from</span> <span class="token string">'../models/branch'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../models/rejectPeya'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- ANTES: El modelo se importaba para ser utilizado.</span>
<span class="token keyword">import</span> platforms <span class="token keyword">from</span> <span class="token string">'../models/platform'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
            </code></pre>
            <b>Código Nuevo:</b>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> settings <span class="token keyword">from</span> <span class="token string">'../config/settings'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branch <span class="token keyword">from</span> <span class="token string">'../models/branch'</span><span class="token punctuation">;</span>
<span class="token comment">//import rejectPeyaModel from '../models/rejectPeya'; // &lt;-- DESPUÉS: La importación está comentada, indicando que el modelo ya no se usa aquí.</span>
<span class="token keyword">import</span> platforms <span class="token keyword">from</span> <span class="token string">'../models/platform'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
            </code></pre>
            
          

            <h5>2. Desactivación del Rechazo por Local Cerrado</h5>
            <p><b>Explicación:</b> Este es el cambio funcional más importante. Anteriormente, si el método <code>validateNewOrders</code> determinaba que la orden debía ser rechazada por local cerrado (<code>ordersSaved.state === 'CLOSED_RESTAURANT_REJECTED'</code>), el controlador intentaba notificar a PedidosYa sobre el cierre y registraba la URL de rechazo para reintentos. La nueva lógica elimina este comportamiento. El código que creaba un registro en <code>rejectPeyaModel</code> ha sido comentado, y se han añadido notas explícitas del desarrollador que confirman esta nueva regla de negocio: "Actualmente las ordenes no se rechazan por local cerrado NUNCA".</p>
            <b>Código Anterior:</b>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ordersSaved</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ordersSaved<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'CLOSED_RESTAURANT_REJECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (código para notificar a Peya sobre el cierre) ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>urlAvailability<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion closed orden: '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>code<span class="token punctuation">,</span>  <span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>                    
            <span class="token keyword">await</span> branch<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>currentBranch<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">alreadyClosedPeya</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ANTES: Si la orden era rechazada por local cerrado, se creaba un registro en 'rejectPeyaModel' para reintentar el envío del rechazo.</span>
            <span class="token keyword">await</span> rejectPeyaModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>callbackUrls<span class="token punctuation">.</span>orderRejectedUrl
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token comment">// ...</span>
            </code></pre>
            <b>Código Nuevo:</b>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ordersSaved</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ordersSaved<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'CLOSED_RESTAURANT_REJECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (código para notificar a Peya sobre el cierre) ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>urlAvailability<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion closed orden: '</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>code<span class="token punctuation">,</span>  <span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>                    
            <span class="token keyword">await</span> branch<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>currentBranch<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">alreadyClosedPeya</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// DESPUÉS: La lógica de crear un registro de reintento ha sido comentada, deshabilitando la funcionalidad.</span>
            <span class="token comment">// El comentario del desarrollador aclara la nueva regla de negocio.</span>
            <span class="token comment">//Actualmente las ordenes no se rechazan por local cerrado NUNCA</span>
            <span class="token comment">/*await rejectPeyaModel.create({
                url: req.body.callbackUrls.orderRejectedUrl
            });*/</span>
            <span class="token comment">//Actualmente las ordenes no se rechazan por local cerrado NUNCA</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token comment">// ...</span>
            </code></pre>

          <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Se ha desactivado la funcionalidad que rechazaba automáticamente un pedido de PedidosYa si el sistema consideraba que la tienda estaba cerrada.</p>
            <p>El flujo ahora es el siguiente:</p>
            <ol>
                <li>Llega una orden de PedidosYa.</li>
                <li>El sistema detecta que la sucursal está cerrada.</li>
                <li>Se actualiza el estado de la sucursal a <code>alreadyClosedPeya: true</code>.</li>
                <li>NO se hace nada para rechazar la orden en la plataforma de PedidosYa en este punto. La orden simplemente no se procesa para su rechazo.</li>
            </ol>
            
            <p>Este cambio elimina una vieja lógica de rechazo automático para PedidosYa.</p>
          </div>
        </div>
      </details>
        <details class="component-card">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/mercadoPago.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
          Los cambios en este archivo introducen una <b>nueva lógica de negocio</b> para el flujo de aceptación de pedidos de MercadoPago, haciéndolo configurable. La decisión de aceptar un pedido automáticamente ya no está codificada de forma fija, sino que ahora depende de reglas de <b>auto-aceptación</b> que pueden ser definidas a nivel de cadena (tenant) y/o de sucursal (branch).
      </p>
      <p>Esto establece<b> 2 flujos:</b></p>
      <ul>
        <li><b>Flujo Automático:</b> Si una regla <code>autoAccept</code> está activa, la orden se confirma inmediatamente al ser recibida (en el método <code>receiveOrder</code>).</li>
        <li><b>Flujo Manual:</b> Si no hay reglas de auto-aceptación, la orden espera una confirmación manual, que se gestiona a través del método <code>confirmOrder</code>.</li>
      </ul>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Importación de Dependencias Adicionales</h5>
      <p><b>Explicación:</b> Se añade la importación del modelo <code>branchModel</code>.Ya que permite al código consultar la base de datos para verificar si existen reglas de auto-aceptación configuradas para la sucursal o la cadena a la que pertenece la orden.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> NewsStateSingleton <span class="token keyword">from</span> <span class="token string">'../../../utils/newsState'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mercadoPagoClientModel <span class="token keyword">from</span> <span class="token string">'../../../models/mercadoPagoClient'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> NewsStateSingleton <span class="token keyword">from</span> <span class="token string">'../../../utils/newsState'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mercadoPagoClientModel <span class="token keyword">from</span> <span class="token string">'../../../models/mercadoPagoClient'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branchModel <span class="token keyword">from</span> <span class="token string">'../../../models/branch'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo de sucursal para consultar las reglas.</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método, que se activa cuando llega una <code>news</code> para enviar <code>recieve</code>, ha sido refactorizado para manejar el flujo de <b>aceptación automática</b>. Su responsabilidad ahora es verificar si existen reglas de <code>autoAccept</code> y, solo si se cumplen, proceder a notificar la aceptación a la API de MercadoPago.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: La lógica era simple. Si la orden estaba en estado pendiente (statusId === 1), se aceptaba incondicionalmente.</span>
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mercadoPagoClient <span class="token operator">=</span> <span class="token keyword">await</span> mercadoPagoClientModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> order<span class="token punctuation">.</span>branchId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
        <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"accepted"</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/proximity-integration/shipments/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> 
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder MercadoPago'</span><span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'MercadoPago'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>          
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// DESPUÉS: La condición ahora verifica que la plataforma esté configurada para recibir y confirmar, y que la orden sea nueva.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca la sucursal y se popula la información de la cadena a la que pertenece.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca una regla de auto-aceptación específica para esta plataforma a nivel de sucursal.</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
          <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>rules <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>internalCode <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>internalCode <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>autoAccept
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca una regla de auto-aceptación a nivel de cadena (tenant).</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
          <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>platformId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>internalCode <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>autoAccept
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Si se encuentra una regla en cualquiera de los dos niveles, se activa la auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API de MercadoPago solo se ejecuta si se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>            
          <span class="token keyword">let</span> mercadoPagoClient <span class="token operator">=</span> <span class="token keyword">await</span> mercadoPagoClientModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> order<span class="token punctuation">.</span>branchId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
          <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"accepted"</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>         
          <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/proximity-integration/shipments/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Si no hay regla, no se hace nada en este paso.</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder MercadoPago'</span><span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'MercadoPago'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>          
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>3. Modificación del Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Este método, que se activa con una confirmación manual desde el POS, ahora maneja el flujo de <b>aceptación manual</b>. Su lógica es la inversa de <code>receiveOrder</code>: solo notificará a la API de MercadoPago si la orden <b>NO</b> fue aceptada automáticamente en el paso anterior.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método solo actualizaba el estado interno de la orden y no realizaba ninguna llamada a la API externa.</span>
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>      
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder MercadoPago '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span> deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'MercadoPago'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>      
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: Se verifica si la plataforma está configurada para enviar confirmaciones.</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se replica la misma lógica de búsqueda de reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Esta es la lógica clave. La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>       
          <span class="token keyword">let</span> mercadoPagoClient <span class="token operator">=</span> <span class="token keyword">await</span> mercadoPagoClientModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branches</span><span class="token operator">:</span> order<span class="token punctuation">.</span>branchId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
          <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"accepted"</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>          
          <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/proximity-integration/shipments/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>order<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Si ya se auto-aceptó, no se hace nada para evitar duplicados.                   </span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder MercadoPago '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span> deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'MercadoPago'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>Las modificaciones transforman el comportamiento de la integración con MercadoPago de estático a <b>configurable</b>.</p>
      <ul>
          <li><b>Comportamiento Configurable:</b> La decisión de aceptar un pedido automáticamente ya no está codificada de forma fija. Ahora depende de la configuración de la base de datos a nivel de <code>chain</code> (tenant) y <code>branch</code> (sucursal).</li>
          <li><b>Flujo(Automático vs. Manual):</b>
              <ul>
                  <li><code>receiveOrder</code> se encarga de la <b>aceptación automática</b> si la regla <code>autoAccept</code> está presente.</li>
                  <li><code>confirmOrder</code> se encarga de la <b>aceptación manual</b>, pero solo si la aceptación automática no estaba configurada, previniendo acciones redundantes.</li>
              </ul>
          </li>
      </ul>
    </div>
  </div>
</details>  
    <details class="component-card">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/pedidosYa.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
        Los cambios en PedidosYa implementan la misma arquitectura de <b>reglas de auto-aceptación</b> vista en MercadoPago, pero con una capa adicional: el <b>cálculo dinámico del tiempo de preparación del pedido</b>.
      </p>
      <p>
        Esto transforma el flujo de aceptación de un proceso estático a uno configurable, donde no solo se decide si aceptar automáticamente, sino también <b>cuándo estará listo el pedido</b>, basándose en la configuración del tenant (cadena/sucursal).
      </p>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método ha sido completamente refactorizado para manejar el flujo de <b>aceptación automática</b>. Ahora, en lugar de aceptar incondicionalmente, primero verifica si existen reglas de <code>autoAccept</code> y, si es así, calcula un tiempo de preparación dinámico para enviarlo en la notificación a la API de PedidosYa.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: La lógica era simple. Si la orden estaba en estado pendiente, se aceptaba inmediatamente enviando un 'acceptanceTime: null'.</span>
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string-property property">'order.code'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">acceptanceTime</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token literal-property property">remoteOrderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'order_accepted'</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> url <span class="token operator">=</span> fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>callbackUrls<span class="token punctuation">.</span>orderAcceptedUrl<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ... (manejo de error simple)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>   
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// DESPUÉS: La condición ahora verifica que la plataforma esté configurada para el ciclo completo y que la orden sea nueva.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
          <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se busca la sucursal y se popula la información de la cadena para acceder a las reglas.</span>
          <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se busca una regla de auto-aceptación a nivel de sucursal.</span>
          <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>rules <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>internalCode <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>internalCode <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>autoAccept
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se busca una regla de auto-aceptación a nivel de cadena.</span>
          <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>platformId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>internalCode <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>autoAccept
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
            boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: La lógica de aceptación solo se ejecuta si se encontró una regla.</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// DESPUÉS: Se determina el ID del tiempo de preparación según la jerarquía de reglas (sucursal &gt; cadena).</span>
            <span class="token keyword">let</span> preparationTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
            <span class="token keyword">if</span> <span class="token punctuation">(</span>branchPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              preparationTime <span class="token operator">=</span> branchPlatform<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              preparationTime <span class="token operator">=</span> chainRule<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTimeId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// DESPUÉS: Se calcula la hora exacta en que el pedido estará listo.</span>
            <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
            <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> preparationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
            <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> readyForPickup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyForPickup<span class="token punctuation">.</span><span class="token function">setMinutes</span><span class="token punctuation">(</span>readyForPickup<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>timeMins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token string-property property">'order.code'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// DESPUÉS: El 'acceptanceTime' en el body ahora contiene la hora calculada en formato ISO.</span>
            <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">acceptanceTime</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">remoteOrderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'order_accepted'</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> url <span class="token operator">=</span> fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>callbackUrls<span class="token punctuation">.</span>orderAcceptedUrl<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion confirm Peya'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// DESPUÉS: Si la llamada falla, se guarda el tiempo calculado para futuros reintentos.</span>
              <span class="token keyword">await</span> rejectPeyaModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">url</span><span class="token operator">:</span> fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>callbackUrls<span class="token punctuation">.</span>orderAcceptedUrl<span class="token punctuation">,</span>
                <span class="token literal-property property">platformId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                <span class="token string-property property">'extraData.readyForPickup'</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder peya IN'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder general Peya'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Este método ahora maneja el flujo de <b>aceptación manual</b>, que se ejecuta solo si no se aplicó la auto-aceptación. Al igual que <code>receiveOrder</code>, ha sido modificado para calcular y enviar un tiempo de preparación, pero esta vez basándose en el <code>deliveryTimeId</code> proporcionado por el POS.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método solo actualizaba el estado interno y no realizaba ninguna llamada a la API externa.</span>
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder Peya 3'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span> deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: Se añade la lógica para verificar si debe actuar.</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca si existen reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>       
          <span class="token comment">// DESPUÉS: Se calcula el tiempo de preparación, pero usando el 'deliveryTimeId' que viene del POS.</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> deliveryTimeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> readyForPickup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          readyForPickup<span class="token punctuation">.</span><span class="token function">setMinutes</span><span class="token punctuation">(</span>readyForPickup<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>timeMins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              
                
          <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string-property property">'order.code'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se construye y envía el payload a la API de PedidosYa con el tiempo calculado.</span>
          <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">acceptanceTime</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">remoteOrderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'order_accepted'</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> url <span class="token operator">=</span> fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>callbackUrls<span class="token punctuation">.</span>orderAcceptedUrl<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error mejorado, igual que en receiveOrder)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder Peya 3'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span> deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PedidosYa'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>
        <code>Pedidos Ya</code> se actualiza de forma similar a <code>mercadoPago.js</code>, pero con una capa adicional:
      </p>
      <ul>
          <li><b>Aceptación Condicional:</b> Implementa el mismo flujo (automático vs. manual) basado en reglas de <code>autoAccept</code>.</li>
          <li><b>Cálculo Dinámico del Tiempo de Preparación:</b> El sistema ya no solo decide si aceptar, sino también <b>cuándo estará listo el pedido</b>, basándose en la configuración del tenant.</li>
          <li><b>Tiempos de Preparación Contextuales:</b>
              <ul>
                  <li>En la aceptación automática, el tiempo se toma de las nuevas reglas (<code>rules.preparationTime</code>).</li>
                  <li>En la confirmación manual, el tiempo se toma del parámetro <code>deliveryTimeId</code>, que es proporcionado por el POS en el momento de la acción.</li>
              </ul>
          </li>
          <li><b>Reintentos:</b> Guardar el <code>readyForPickup</code> en <code>extraData</code> hace que el sistema de reintentos sea más fiable y consistente.</li>
      </ul>
    </div>
  </div>
 </details>      
          
<details class="component-card">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/rapiboy.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
        Los cambios en este archivo adaptan la integración con Rapiboy (PediGrido) al sistema de <b>reglas de auto-aceptación</b>. El patrón es muy similar al implementado en <code>pedidosYa</code>, pero se ajusta a las particularidades de la API de PediGrido, que utiliza un campo <code>Demora</code> en lugar de un <code>acceptanceTime</code>.
      </p>
      <p>
        La modificación principal es reemplazar un comportamiento de aceptación fijo por un sistema <b>configurable</b>, donde el tiempo de preparación (Demora) se obtiene de las reglas definidas a nivel de cadena o sucursal.
      </p>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Importación de Dependencias Adicionales</h5>
      <p><b>Explicación:</b> Se añade la importación del modelo <code>branchModel</code>. Esto es importante para la nueva funcionalidad, ya que permite consultar la base de datos para verificar si existen reglas de <code>autoAccept</code> y obtener los tiempos de preparación configurados.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_BRANCH</span><span class="token punctuation">,</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../../../models/rejectPeya'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_BRANCH</span><span class="token punctuation">,</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../../../models/rejectPeya'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branchModel <span class="token keyword">from</span> <span class="token string">'../../../models/branch'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo de sucursal para consultar las reglas.</span>
<span class="token comment">// ...</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método ha sido refactorizado para manejar el flujo de <b>aceptación automática</b>. Ahora verifica si existen reglas de <code>autoAccept</code> y, si es así, utiliza el tiempo de preparación configurado en esas reglas para enviarlo en el campo <code>Demora</code> a la API de PediGrido.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: La lógica aceptaba la orden incondicionalmente si estaba en estado pendiente, enviando un valor fijo 'Demora: 1'.</span>
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>      
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>          
        <span class="token keyword">try</span> <span class="token punctuation">{</span>  
          <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">Token</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">,</span>
              <span class="token literal-property property">IdPedido</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              <span class="token literal-property property">Demora</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// ... (manejo de error simple)</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>               
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>           
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>          
        <span class="token keyword">try</span> <span class="token punctuation">{</span>  
          <span class="token comment">// DESPUÉS: La condición ahora verifica que la plataforma esté configurada para el ciclo completo y que la orden sea nueva.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           
            <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// DESPUÉS: Se busca la sucursal y la cadena para acceder a las reglas.</span>
            <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
              boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
            <span class="token comment">// DESPUÉS: La lógica de aceptación solo se ejecuta si se encontró una regla de auto-aceptación.</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// DESPUÉS: Se determina el ID del tiempo de preparación según la jerarquía de reglas (sucursal &gt; cadena).</span>
              <span class="token keyword">let</span> preparationTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
              <span class="token keyword">if</span> <span class="token punctuation">(</span>branchPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                preparationTime <span class="token operator">=</span> branchPlatform<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTime<span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                preparationTime <span class="token operator">=</span> chainRule<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTimeId<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token comment">// DESPUÉS: El campo 'Demora' ahora es dinámico, basado en el tiempo de preparación configurado.</span>
              <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">Token</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                <span class="token literal-property property">IdPedido</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                <span class="token literal-property property">Demora</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>preparationTime<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion confirm rapiboy '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// DESPUÉS: Si la llamada falla, se guarda el valor de 'Demora' para futuros reintentos.</span>
                <span class="token keyword">await</span> rejectPeyaModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                  <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
                  <span class="token literal-property property">platformId</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                  <span class="token string-property property">'extraData.Demora'</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>preparationTime<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>      
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder rapiboy '</span><span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>  <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder general rapiboy'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>3. Modificación del Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Este método ahora maneja el flujo de <b>aceptación manual</b>. Solo notificará a la API de Rapiboy si la orden <b>NO</b> fue aceptada automáticamente, y utilizará el <code>deliveryTimeId</code> proporcionado por el POS como valor para el campo <code>Demora</code>.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método solo actualizaba el estado interno de la orden y no realizaba ninguna llamada a la API externa.</span>
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder rapiboy '</span><span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>  <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span>deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: Se añade la lógica para verificar si debe actuar.</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca si existen reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
          <span class="token comment">// DESPUÉS: El campo 'Demora' ahora se basa en el 'deliveryTimeId' que viene del POS.</span>
          <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">Token</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">,</span>
            <span class="token literal-property property">IdPedido</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            <span class="token literal-property property">Demora</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>deliveryTimeId<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion confirm rapiboy '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// DESPUÉS: Se guarda el valor de 'Demora' en el registro de reintento.</span>
            <span class="token keyword">await</span> rejectPeyaModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
              <span class="token literal-property property">platformId</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
              <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              <span class="token string-property property">'extraData.Demora'</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>deliveryTimeId<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder rapiboy '</span><span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>  <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">deliveryTimeId</span><span class="token operator">:</span>deliveryTimeId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'PediGrido'</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>Cambios en la integración de <code>PediGrido</code>.</p>
      <ul>
          <li><b>Aceptación Condicional y Flujo Dual:</b> Se implementa el sistema de <code>autoAccept</code> basado en reglas y el comportamiento complementario en <code>confirmOrder</code>.</li>
          <li><b>Demora:</b> El campo <code>Demora</code>, que era estático, ahora es configurable, ya sea a través de las reglas en la aceptación automática o a través de un parámetro en la confirmación manual.</li>
          <li><b>API Específica:</b> A diferencia de <code>pedidosYa</code> que calcula minutos y una fecha ISO, aquí la lógica es más directa, ya que la API de PediGrido espera un valor numérico simple para <code>Demora</code>, que se corresponde con el <code>preparationTime</code> de las reglas.</li>
          <li><b>Reintentos Mejorados:</b> Se guarda el contexto (Demora) en <code>extraData</code> para asegurar la consistencia en caso de fallos de comunicación.</li>
      </ul>
    </div>
  </div>
 </details>

<details class="component-card">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/rappi.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
        La actualización introduce la lógica de <b>reglas de auto-aceptación</b> y el <b>cálculo de tiempo de preparación</b>, ademas también <b>añade desde cero el método <code>confirmOrder</code></b>. Esto completa el flujo dual (automático/manual) para Rappi, alineando su comportamiento con el de las otras plataformas principales y representando una mejora funcional sustancial.
      </p>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Importación de Dependencias Adicionales</h5>
      <p><b>Explicación:</b> Se añade la importación del modelo <code>branchModel</code>, para poder consultar la base de datos y verificar la existencia de reglas de <code>autoAccept</code> a nivel de sucursal y cadena.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token constant">UUID</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/utils'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../../../models/rejectPeya'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> <span class="token constant">UUID</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/utils'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../../../models/rejectPeya'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branchModel <span class="token keyword">from</span> <span class="token string">'../../../models/branch'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo de sucursal para consultar las reglas.</span>
<span class="token comment">// ...</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método ha sido refactorizado para manejar el flujo de <b>aceptación automática</b>. Ahora, en lugar de aceptar, primero verifica si existen reglas de <code>autoAccept</code>. Si es así, calcula un tiempo de preparación y lo envía como parte de la URL a la API de Rappi.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: La lógica aceptaba la orden si la plataforma estaba configurada para 'receive' y el estado era pendiente.</span>
<span class="token comment">// La URL de aceptación era fija (.../take).</span>
<span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">/* LOGIN  */</span>       
          <span class="token keyword">const</span> xAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRappi<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">/* SEND CONFIRMED */</span>
          <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span>
              <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take'</span>
              <span class="token operator">:</span> <span class="token string">'https://microservices.dev.rappi.com'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take'</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error simple)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>           
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// DESPUÉS: La condición ahora verifica que la plataforma esté configurada para el ciclo completo y que la orden sea nueva.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca la sucursal y la cadena para acceder a las reglas.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La lógica de aceptación solo se ejecuta si se encontró una regla.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// DESPUÉS: Se determina el ID del tiempo de preparación y se calcula el tiempo promedio en minutos.</span>
          <span class="token keyword">let</span> preparationTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
          <span class="token keyword">if</span> <span class="token punctuation">(</span>branchPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            preparationTime <span class="token operator">=</span> branchPlatform<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTime<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            preparationTime <span class="token operator">=</span> chainRule<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTimeId<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> preparationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
          <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>   
           <span class="token comment">/* LOGIN  */</span>       
          <span class="token keyword">const</span> xAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRappi<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">/* SEND CONFIRMED */</span>
          <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: El tiempo de preparación calculado ('timeMins') se concatena directamente al final de la URL.</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span>
              <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take/'</span><span class="token operator">+</span>timeMins
              <span class="token operator">:</span> <span class="token string">'https://microservices.dev.rappi.com'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take/'</span><span class="token operator">+</span>timeMins<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error sin cambios funcionales)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>    
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveOrder rappi'</span><span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'Rappi'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>3. Creación del Nuevo Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Antes, la clase <code>Rappi</code> no tenía un método <code>confirmOrder</code>. La creación de este método alinea a Rappi con el comportamiento del resto de las plataformas, permitiendo la aceptación de órdenes que no fueron procesadas automáticamente.</p>
      <b>Código Nuevo (Método Completo):</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// DESPUÉS: Se añade el método 'confirmOrder' que antes no existía.</span>
<span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: Se verifica si la plataforma está configurada para enviar confirmaciones.</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se replica la misma lógica de búsqueda de reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// DESPUÉS: Se calcula el tiempo de preparación, pero usando el 'deliveryTimeId' que viene del POS.</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> deliveryTimeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
      
          <span class="token comment">/* LOGIN  */</span>       
          <span class="token keyword">const</span> xAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRappi<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">/* SEND CONFIRMED */</span>
          <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se construye y envía el payload a la API de Rappi con el tiempo calculado en la URL.</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span>
              <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">[</span>order<span class="token punctuation">.</span>country<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take/'</span><span class="token operator">+</span>timeMins
              <span class="token operator">:</span> <span class="token string">'https://microservices.dev.rappi.com'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmOrders <span class="token operator">+</span> order<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'/take/'</span><span class="token operator">+</span>timeMins<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error y registro para reintento)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder rappi'</span><span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> order<span class="token punctuation">,</span> <span class="token literal-property property">branchId</span><span class="token operator">:</span> branchId<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'Platform'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>Cambios en la integración con Rappi:</p>
      <ul>
          <li><b>Funcionalidad <code>confirmOrder</code> Añadida:</b> Se ha creado desde cero el flujo de confirmación manual, lo que representa una nueva capacidad para la integración con Rappi.</li>
          <li><b>Aceptación Condicional:</b> Se implementa el flujo dual (automático vs. manual) basado en reglas de <code>autoAccept</code>.</li>
          <li><b>Tiempo de Preparación en la URL:</b> La lógica se adapta a la API específica de Rappi, que requiere el tiempo de preparación como parte de la ruta de la URL.</li>
      </ul>
    </div>
  </div>
 </details>

<details class="component-card">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/thirdParty.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <ul>
          <li><b>Implementación del Sistema de Reglas:</b> Se introduce la lógica de <code>auto-aceptación</code> configurable a nivel de cadena y sucursal, permitiendo un flujo de confirmación automático y dinámico.</li>
          <li><b>Refactorización del Manejo de Errores:</b> Se estandariza y simplifica el manejo de errores en todas las llamadas a APIs externas. En lugar de devolver objetos de error complejos, los métodos ahora "silencian" el error (después de loguearlo) y devuelven un <code>false</code>, simplificando el código que los consume.</li>
      </ul>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Importación de Dependencias Adicionales</h5>
      <p><b>Explicación:</b> Se añade la importación del modelo <code>branchModel</code> para poder consultar la base de datos y verificar la existencia de reglas de <code>autoAccept</code> configuradas para la sucursal o la cadena.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> CustomError <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/customError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_BRANCH</span><span class="token punctuation">,</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> CustomError <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/customError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_BRANCH</span><span class="token punctuation">,</span> <span class="token constant">APP_PLATFORM</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../utils/errors/codeError'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branchModel <span class="token keyword">from</span> <span class="token string">'../../../models/branch'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo de sucursal para consultar las reglas.</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método ahora tiene una doble responsabilidad. Si existen reglas de <code>autoAccept</code>, intenta <b>confirmar</b> la orden directamente. Si no hay reglas y la plataforma está configurada solo para "recibir", ejecuta la lógica original de notificar la recepción.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método solo notificaba la recepción de la orden si 'statusResponse.receive' era true.</span>
<span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... llamada axios.post a this.urlReceive</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... llamada axios.post a this.urlReceive</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// DESPUÉS: La condición principal ahora verifica si la plataforma está configurada para el ciclo completo de confirmación.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca la sucursal y la cadena para acceder a las reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Si se encuentra una regla, se ejecuta el flujo de ACEPTACIÓN AUTOMÁTICA.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token comment">// DESPUÉS: Se calcula el tiempo de preparación ('Demora') a partir de las reglas.</span>
          <span class="token keyword">let</span> preparationTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
          <span class="token keyword">if</span> <span class="token punctuation">(</span>branchPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             preparationTime <span class="token operator">=</span> branchPlatform<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTime<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            preparationTime <span class="token operator">=</span> chainRule<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTimeId<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> preparationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// DESPUÉS: Se realiza la llamada a la API externa, pero al endpoint de CONFIRMACIÓN ('this.urlConfirmed').</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">Token</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token literal-property property">IdPedido</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">Demora</span><span class="token operator">:</span> time<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlConfirmed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (lógica similar con authData)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// DESPUÉS: Se añade esta condición para mantener el comportamiento original si la plataforma solo está configurada para recibir.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (lógica original de llamada a 'this.urlReceive')</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>3. Modificación del Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Este método ahora maneja el flujo de <b>aceptación manual</b>. Solo notificará a la API externa si la orden <b>NO</b> fue aceptada automáticamente en el paso anterior.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método realizaba la llamada de confirmación incondicionalmente si 'statusResponse.confirm' era true.</span>
<span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ... llamada axios.post a this.urlConfirmed</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ... llamada axios.post a this.urlConfirmed</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Devolvía un objeto de error complejo.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se replica la misma lógica de búsqueda de reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (lógica original de llamada a 'this.urlConfirmed')</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (lógica original de llamada a 'this.urlConfirmed')</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Si ya se auto-aceptó, no se hace nada.</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>      
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder 2 thirdParty '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: El manejo de errores se simplifica. Se loguea el error y siempre se resuelve con 'false'.</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>4. Refactorización del Manejo de Errores y Limpieza de Código</h5>
      <p><b>Explicación:</b> Este cambio se aplica a todos los métodos que realizan llamadas <code>axios</code> (<code>dispatchOrder</code>, <code>deliveryOrder</code>, <code>branchRejectOrder</code>). Se estandariza el manejo de errores para que sea más simple y consistente.</p>
      <b>Código Anterior (Ejemplo en <code>dispatchOrder</code>):</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> error <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token string">'Failed to send the dispatched status.'</span><span class="token punctuation">;</span>
  <span class="token comment">// ANTES: Se creaba un objeto de error complejo y se resolvía la promesa con él.</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomError</span><span class="token punctuation">(</span><span class="token constant">APP_PLATFORM</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uuid<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo (Ejemplo en <code>dispatchOrder</code>):</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// DESPUÉS: Se loguea el error y la promesa siempre se resuelve con 'false'.</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
      </code></pre>
      <p>Adicionalmente, se eliminaron las asignaciones de respuesta de <code>axios</code> a variables <code>res</code> que no se utilizaban, limpiando el código.</p>


    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>Los cambios en la clase <code>ThirdParty</code>:</p>
      <ul>
          <li><b>Integración del Sistema de Reglas:</b> Se ha adaptado completamente al nuevo sistema de <code>autoAccept</code> y cálculo de <code>Demora</code>, con la flexibilidad añadida para soportar flujos de solo-recepción.</li>
          <li><b>Estandarización del Manejo de Errores:</b> Se ha refactorizado todo el manejo de errores delegando los detalles al log y devolviendo siempre un booleano.</li>
          <li><b>Flujo de Confirmación:</b> El método <code>receiveOrder</code> ahora es capaz de confirmar directamente un pedido si las reglas lo indican, haciendo el proceso más eficiente.</li>
      </ul>
    </div>
  </div>
 </details>

<details class="component-card" open="">
  <summary class="component-header">
    <h3>api/src/platforms/management/platform/uberEats.js</h3>
  </summary>
  <div class="component-body">
      <h4>Análisis General</h4>
      <p>
        La actualización de la integración de Uber Eats con el nuevo estándar, siguiendo el patrón casi idéntico al de <code>Pedidos Ya</code>. Se introduce la lógica de <b>rauto-aceptación</b> y el <b>cálculo del tiempo de preparación</b>. Además, se estandariza el manejo de errores.
      </p>
      
      <h4>Cambios Detallados</h4>

      <h5>1. Importación de Dependencias Adicionales</h5>
      <p><b>Explicación:</b> Se añade la importación de <code>branchModel</code> y <code>rejectPeyaModel</code>. <code>branchModel</code> para consultar las nuevas reglas de <code>autoAccept</code>, mientras que <code>rejectPeyaModel</code> se utiliza para el sistema de reintentos de notificaciones.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> NewsStateSingleton <span class="token keyword">from</span> <span class="token string">'../../../utils/newsState'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> orderModel <span class="token keyword">from</span> <span class="token string">'../../../models/order'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> FormData <span class="token keyword">from</span> <span class="token string">'form-data'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ...</span>
<span class="token keyword">import</span> NewsStateSingleton <span class="token keyword">from</span> <span class="token string">'../../../utils/newsState'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> orderModel <span class="token keyword">from</span> <span class="token string">'../../../models/order'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> branchModel <span class="token keyword">from</span> <span class="token string">'../../../models/branch'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo de sucursal para consultar las reglas.</span>
<span class="token keyword">import</span> rejectPeyaModel <span class="token keyword">from</span> <span class="token string">'../../../models/rejectPeya'</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- DESPUÉS: Se importa el modelo para reintentos.</span>
<span class="token keyword">import</span> FormData <span class="token keyword">from</span> <span class="token string">'form-data'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Log <span class="token keyword">from</span> <span class="token string">'../../../utils/log'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
      </code></pre>
      
      <h5>2. Modificación del Método <code>receiveOrder</code></h5>
      <p><b>Explicación:</b> Este método ha sido refactorizado para manejar el flujo de <b>aceptación automática</b>. Ahora verifica si existen reglas de <code>autoAccept</code> y, si es así, calcula un tiempo de preparación dinámico para enviarlo en el campo <code>ready_for_pickup_time</code> a la API de Uber Eats.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: La lógica aceptaba la orden si la plataforma estaba configurada para ello, enviando un 'ready_for_pickup_time: null'.</span>
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">'order.id'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"ready_for_pickup_time"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token string-property property">"external_id"</span><span class="token operator">:</span> <span class="token string">"external_id"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"accepted_by"</span><span class="token operator">:</span> <span class="token string">"Grido"</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/delivery/order/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>oldId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error simple)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>       
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">receiveOrder</span><span class="token punctuation">(</span><span class="token parameter">order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// DESPUÉS: La condición principal ahora verifica que la plataforma esté configurada para el ciclo completo y que la orden sea nueva.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>receive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm <span class="token operator">&amp;&amp;</span> order<span class="token punctuation">.</span>statusId <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca la sucursal y la cadena para acceder a las reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La lógica de aceptación solo se ejecuta si se encontró una regla.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// DESPUÉS: Se determina el ID del tiempo de preparación y se calcula la hora exacta en que el pedido estará listo.</span>
          <span class="token keyword">let</span> preparationTime <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
          <span class="token keyword">if</span> <span class="token punctuation">(</span>branchPlatform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            preparationTime <span class="token operator">=</span> branchPlatform<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTime<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            preparationTime <span class="token operator">=</span> chainRule<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>preparationTimeId<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> preparationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> readyForPickup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          readyForPickup<span class="token punctuation">.</span><span class="token function">setMinutes</span><span class="token punctuation">(</span>readyForPickup<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>timeMins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">'order.id'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
          <span class="token comment">// DESPUÉS: El 'ready_for_pickup_time' en el body ahora contiene la hora calculada en formato ISO.</span>
          <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"ready_for_pickup_time"</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string-property property">"external_id"</span><span class="token operator">:</span> <span class="token string">"external_id"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"accepted_by"</span><span class="token operator">:</span> <span class="token string">"Grido"</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/delivery/order/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>oldId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló peticion confirm Uber'</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'UberEats'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// DESPUÉS: Si la llamada falla, se guarda el tiempo calculado para futuros reintentos.</span>
            <span class="token keyword">await</span> rejectPeyaModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
              <span class="token literal-property property">platformId</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
              <span class="token literal-property property">orderId</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
              <span class="token string-property property">'extraData.readyForPickup'</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló receiveConfirmOrder Uber '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'UberEats'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

      <h5>3. Modificación del Método <code>confirmOrder</code></h5>
      <p><b>Explicación:</b> Este método ahora maneja el flujo de <b>aceptación manual</b>. Solo notificará a la API de Uber Eats si la orden <b>NO</b> fue aceptada automáticamente, y utilizará el <code>deliveryTimeId</code> proporcionado por el POS para calcular el tiempo de preparación.</p>
      <b>Código Anterior:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token comment">// ANTES: El método solo actualizaba el estado interno y no realizaba ninguna llamada a la API externa.</span>
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Devolvía un objeto de error complejo.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>
      <b>Código Nuevo:</b>
      <pre class="language-javascript" tabindex="0"><code class="language-javascript">
<span class="token keyword">async</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> deliveryTimeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> NewsStateSingleton<span class="token punctuation">.</span><span class="token function">stateByCod</span><span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOrderState</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: Se añade la lógica para verificar si debe actuar.</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusResponse<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boolRules <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: Se busca si existen reglas de auto-aceptación.</span>
        <span class="token keyword">const</span> currentBranch <span class="token operator">=</span> <span class="token keyword">await</span> branchModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">branchId</span> <span class="token operator">:</span> order<span class="token punctuation">.</span>branchId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">"chain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> branchPlatform <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>platforms<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chainRule <span class="token operator">=</span> currentBranch<span class="token punctuation">.</span>chain<span class="token punctuation">.</span>platformRules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token comment">/* ... */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>branchPlatform <span class="token operator">||</span> chainRule<span class="token punctuation">)</span>
          boolRules <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// DESPUÉS: La llamada a la API solo se ejecuta si NO se encontró una regla de auto-aceptación.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>boolRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>       
          <span class="token comment">// DESPUÉS: Se calcula el tiempo de preparación, pero usando el 'deliveryTimeId' que viene del POS.</span>
          <span class="token keyword">let</span> deliveryTimes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          deliveryTimes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../assets/deliveryTimes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generic<span class="token punctuation">;</span>
          <span class="token keyword">let</span> time <span class="token operator">=</span> deliveryTimes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> deliveryTimeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token keyword">let</span> timeMins <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>maxMinutes <span class="token operator">+</span> time<span class="token punctuation">.</span>minMinutes <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
      
          <span class="token keyword">let</span> fullOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">'order.id'</span><span class="token operator">:</span> order<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> readyForPickup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyForPickup<span class="token punctuation">.</span><span class="token function">setMinutes</span><span class="token punctuation">(</span>readyForPickup<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>  Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>timeMins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"ready_for_pickup_time"</span><span class="token operator">:</span> readyForPickup<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string-property property">"external_id"</span><span class="token operator">:</span> <span class="token string">"external_id"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"accepted_by"</span><span class="token operator">:</span> <span class="token string">"Grido"</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> headersConfig <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platform<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>data<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/delivery/order/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fullOrder<span class="token punctuation">.</span>order<span class="token punctuation">.</span>oldId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/accept</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> body<span class="token punctuation">,</span> headersConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... (manejo de error mejorado, igual que en receiveOrder)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">saveError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Falló confirmOrder Uber '</span> <span class="token operator">+</span> order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// DESPUÉS: El manejo de errores se simplifica. Se loguea el error y siempre se resuelve con 'false'.</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </code></pre>

    <div class="analysis-box">
      <h4>Conclusión del análisis</h4>
      <p>Cambios en la integración con <code>uberEats.js</code>.</p>
      <ul>
          <li><b>Aceptación Condicional y Flujo:</b> Se implementa el sistema de <code>autoAccept</code> basado en reglas y el comportamiento complementario en <code>confirmOrder</code>.</li>
          <li><b>Cálculo de Tiempo de Preparación:</b> El campo <code>ready_for_pickup_time</code>, que antes era nulo, ahora se configura, permitiendo a los tenants especificar sus propios tiempos de preparación para Uber Eats.</li>
          <li><b>Manejo de Errores Estandarizado:</b> Se ha refactorizado el método <code>confirmOrder</code> para eliminar el manejo de errores personalizado y alinearlo con el nuevo estándar de <code>resolve(false)</code>.</li>
      </ul>
    </div>
  </div>
</details>

<details class="component-card">
    <summary class="component-header">
        <h3>api/src/platforms/management/platform.js commit 0fb1691576e1115ca933af17eeda03ab3d0a7d0a</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Los cambios propaga la información del tenant a través de todo el sistema de procesamiento de órdenes.
        </p>
        <p>
            La modificación principal consiste en:
        </p>
        <ul>
            <li>**Definir una lista estática de tenants:** Se introduce un array `tenants` que actúa como un mapa entre el nombre de una cadena (ej. "grido") y sus identificadores únicos (`orgId`, `tenantId`).</li>
            <li>**Inyectar la información del tenant:** En los métodos clave que procesan nuevas órdenes (`saveNewOrders` y `saveNewOrdersAutomally`), el sistema ahora identifica a qué tenant pertenece la orden y pasa esta información a los parsers de cada plataforma.</li>
        </ul>
        <p>Este cambio asegura que cada orden tenga los datos del tenant correcto desde su creación.</p>
        <h4>Cambios Detallados</h4>
        <h5>1. Definición de la Lista de Tenants</h5>
        <p><b>Explicación:</b> Se ha añadido un nuevo array constante llamado `tenants` al inicio del archivo. Este array contiene objetos que definen la información de cada tenant (cliente/cadena) que utiliza la plataforma. Esta lista está "hardcodeada", lo que significa que para añadir un nuevo tenant se requerirá una modificación en el código.</p>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: No existía una lista de tenants definida.
// ...
import orderRejClosedModel from '../../models/orderRejClosed';
import Log from '../../utils/log';
let plarforms22 = [1, 2, 4, 7, 11, 12]
class Platform {
// ...
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se añade un array estático que mapea nombres de cadena a IDs de tenant.
// ...
import orderRejClosedModel from '../../models/orderRejClosed';
import Log from '../../utils/log';
let plarforms22 = [1, 2, 4, 7, 11, 12];
const tenants = [
  {
    "name": "grido",
    "orgId": "org_g4qPlLbxcJZx5e7U",
    "tenantId": "d3186bc6d7b2"
  },
  {
    "name": "weiss",
    "orgId": "org_XAdstuO4gA2oTSaP",
    "tenantId": "kt76igzny9ql"
  },
  {
    "name": "otros",
    "orgId": "org_f2DRvSI5jnbRYKLE",
    "tenantId": "d3186bc6d7b2"
  }
]
class Platform {
// ...
        </code></pre>
        <h5>2. Inyección de Datos del Tenant en el Flujo de Creación de Órdenes</h5>
        <p><b>Explicación:</b> Dentro de los métodos `saveNewOrders` y `saveNewOrdersAutomally`, justo antes de llamar al parser (`this.parser.newsFromOrders`), se ha añadido una línea que busca el tenant correspondiente a la cadena de la sucursal. Luego, el objeto `tenant` encontrado se pasa como un nuevo parámetro a la función `newsFromOrders`.</p>
        <b>Código Anterior (Ejemplo en `saveNewOrders`):</b>
        <pre><code class="language-javascript">
// ANTES: La llamada al parser solo incluía información de la orden, plataforma y sucursal.
// ...
                };

                const newCreator = await this.parser.newsFromOrders(
                  orderCreator,
                  this._platform,
                  newsCode,
                  stateCod,
                  branch,
                  this.uuid
                );

                if(!isOpened && !(plarforms22.includes(this._platform.internalCode))) {
// ...
        </code></pre>
        <b>Código Nuevo (Ejemplo en `saveNewOrders`):</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se identifica el tenant y se inyecta en la llamada al parser.
// ...
                };
            // DESPUÉS: Se busca en el array 'tenants' usando el nombre de la cadena de la sucursal.
            const tenant = tenants.find( r => r.name ===  branch.chain.chain.toLowerCase() );
                const newCreator = await this.parser.newsFromOrders(
                  orderCreator,
                  this._platform,
                  newsCode,
                  stateCod,
                  branch,
                  this.uuid,
                  tenant // <-- DESPUÉS: El objeto 'tenant' se pasa como nuevo parámetro.
                );

                if(!isOpened && !(plarforms22.includes(this._platform.internalCode))) {
// ...
        </code></pre>
        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Este archivo es el punto de origen de la nueva funcionalidad **TENANT**. **Identificación del Tenant**: Cuando un nuevo pedido llega, `platform.js` ahora identifica a qué "cadena" (chain) pertenece la sucursal (ej: "grido", "weiss"). **Búsqueda y Enriquecimiento**: Utiliza la nueva lista `tenants` para encontrar los IDs correspondientes (`orgId`, `tenantId`) a esa cadena. **Propagación de Datos**: "Inyecta" esta información del tenant en los parsers específicos de cada plataforma (mercadoPago.js, pedidosYa.js, etc.), quienes a su vez la embeben en el documento `news`. El propósito de este cambio es asociar cada pedido con un cliente (tenant) específico. Antes, el sistema trataba todos los pedidos de manera uniforme. Ahora, cada pedido lleva una "etiqueta" que indica a quién pertenece, habilitando capacidades críticas para el negocio como el aislamiento de datos y la aplicación de reglas de negocio específicas por cliente.</p>
        </div>
    </div>
</details>

<details class="component-card">
    <summary class="component-header">
        <h3>api/src/platforms/interfaces/glovo.js, mercadoPago.js, pedidosYa.js, rappi.js, thirdParty.js, uberEats.js commit 0fb1691576e1115ca933af17eeda03ab3d0a7d0a</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
      
        <p>
            Anteriormente, los parsers no tenían conocimiento del tenant. Ahora, el  `platform.js` identifica el tenant de la orden y lo "inyecta" en el proceso de parseo. Esto es un paso para habilitar la lógica de negocio multi-tenant, como las reglas de `autoAccept`, y para asegurar la correcta trazabilidad y aislamiento de los datos.
        </p>
        <h4>Cambios Detallados</h4>
        <p>El mismo patrón de modificación se aplicó de manera idéntica en todos los archivos de interfaz. A continuación, se describe el patrón general y luego se muestran los ejemplos de código específicos para cada plataforma.</p>
        <h5>Patrón de Modificación Aplicado:</h5>
        <h6>1. Actualización de Firmas de Funciones para Incluir `tenant`</h6>
        <p><b>Explicación:</b> La función principal `newsFromOrders` y su función interna `orderMapper` en cada parser fueron modificadas para aceptar un nuevo parámetro: `tenant`.</p>
        <b>Código Anterior (Patrón Genérico):</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid) {
    // ...
    const orderMapper = (data, platform, ...) => {
        // ...
    };
    // ...
}
        </code></pre>
        <b>Código Nuevo (Patrón Genérico):</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid, tenant) {
    // ...
    const orderMapper = (data, platform, ..., tenant) => {
        // ...
    };
    // ...
}
        </code></pre>
        <h6>2. Inclusión del Objeto `tenant` en la Orden</h6>
        <p><b>Explicación:</b> Dentro de la función `orderMapper` de cada parser, se añade un nuevo objeto `tenant` al documento de la orden que se está construyendo.</p>
        <b>Código Nuevo (Patrón Genérico):</b>
        <pre><code class="language-javascript">
// ...
const orderMapper = (data, platform, ..., tenant) => {
    // ... (mapeo de id, originalId, etc.)
    order.ownDelivery = ...;
    
    // DESPUÉS: Se enriquece la orden con los datos del tenant.
    order.tenant = {
      name: tenant.name,
      orgId: tenant.orgId,
      tenantId: tenant.tenantId
    }
    return order;
};
// ...
        </code></pre>
        <h6>3. Actualización de la Invocación a `orderMapper`</h6>
        <p><b>Explicación:</b> La línea que invoca a `orderMapper` dentro de `newsFromOrders` se actualiza para pasarle el nuevo parámetro `tenant`.</p>
        <b>Código Anterior (Patrón Genérico):</b>
        <pre><code class="language-javascript">
news.order = orderMapper(data, platform, ...);
        </code></pre>
        <b>Código Nuevo (Patrón Genérico):</b>
        <pre><code class="language-javascript">
news.order = orderMapper(data, platform, ..., tenant);
        </code></pre>
        <h5>Ejemplos de Código por Archivo</h5>
        <h6>api/src/platforms/interfaces/pedidosYa.js</h6>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid) {
    //...
    const orderMapper = (data, platform) => { /*...*/ };
    //...
    news.order = orderMapper(data, platform);
    //...
}
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid, tenant) {
    //...
    const orderMapper = (data, platform, tenant) => {
        //...
        order.tenant = {
            name: tenant.name,
            orgId: tenant.orgId,
            tenantId: tenant.tenantId
        }
        return order;
    };
    //...
    news.order = orderMapper(data, platform, tenant);
    //...
}
        </code></pre>
        <h6>api/src/platforms/interfaces/rappi.js</h6>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
newsFromOrders: function (data, platform, newsCode, stateCod, branch, uuid) {
    //...
    const orderMapper = (data, platform, delivery_operation_type = null) => { /*...*/ };
    //...
    news.order = orderMapper(data, platform, dataOrder.order_detail.delivery_operation_type);
    //...
}
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
newsFromOrders: function (data, platform, newsCode, stateCod, branch, uuid, tenant) {
    //...
    const orderMapper = (data, platform, delivery_operation_type = null, tenant) => {
        //...
        order.tenant = {
            name: tenant.name,
            orgId: tenant.orgId,
            tenantId: tenant.tenantId
        }
        return order;
    };
    //...
    news.order = orderMapper(data, platform, dataOrder.order_detail.delivery_operation_type, tenant);
    //...
}
        </code></pre>
        <h6>api/src/platforms/interfaces/thirdParty.js</h6>
        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid) {
    //...
    const orderMapper = (data, platform) => { /*...*/ };
    //...
    news.order = orderMapper(data, platform);
    //...
}
        </code></pre>
        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
newsFromOrders: async function (data, platform, newsCode, stateCod, branch, uuid, tenant) {
    //...
    const orderMapper = (data, platform, tenant) => {
        //...
        order.tenant = {
            name: tenant.name,
            orgId: tenant.orgId,
            tenantId: tenant.tenantId
        }
        return order;
    };
    //...
    news.order = orderMapper(data, platform, tenant);
    //...
}
        </code></pre>
        <p>(Nota: Los archivos `glovo.js`, `mercadoPago.js`, y `uberEats.js` han sido modificados de la misma manera que el archivo `thirdParty.js`).</p>
        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Este conjunto de cambios es un ejemplo de una refactorización arquitectónica bien ejecutada. No arregla un bug ni añade una pequeña funcionalidad, sino que implementa un cambio clave que transforma la aplicación de un sistema de un solo cliente a una **plataforma multi-inquilino**. Al "etiquetar" cada orden con la información de su tenant desde el momento de la creación, se sientan las bases para: **Aislamiento de Datos:** Gestionar la información de diferentes clientes de forma independiente. **Lógica de Negocio Configurable:** Habilitar funcionalidades como las reglas de `autoAccept` que dependen del tenant. **Escalabilidad y Mantenibilidad:** Asegurar que el sistema pueda crecer y adaptarse a las necesidades de múltiples clientes de forma ordenada.</p>
        </div>
    </div>
</details>

        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>

</html>
