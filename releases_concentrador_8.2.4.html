<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Concentrador 8.2.4 - Optimización y Robustez de Consultas</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Concentrador 8.2.4</h1>
            <p>
                Optimización y robustez de consultas de base de datos en el controlador de sucursales.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 8.2.4</p>
            <p><b>Fecha de Despliegue:</b> [Fecha del Despliegue]</p>
            <p><b>Entorno:</b> [Entorno: Producción/Staging]</p>
            <p><b>AWS Task:</b> 227</p>
            <p><b>Commits:</b> a5aa5da731d9a7c1b2efad5f03a7247189e77e55</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Este release se enfoca en la optimización y limpieza de las consultas a la base de datos dentro del controlador de sucursales (`branch.js`). Los cambios clave incluyen la simplificación de la lógica de filtrado (reemplazando `$or` por `$in`) y la adición de un filtro para excluir explícitamente las sucursales eliminadas lógicamente (`deletedAt: null`) en las funciones de búsqueda y exportación. Estas modificaciones mejoran la legibilidad del código, la integridad de los datos y la eficiencia potencial de las consultas.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <details class="component-card">
                <summary class="component-header">
                    <h3>api/src/controllers/branch.js</h3>
                </summary>
                <div class="component-body">
                    <h4>Análisis General</h4>
                    <p>
                        Esta actualización, como parte de una **Optimización de Consultas a Base de Datos**, se enfoca en refactorizar y mejorar la eficiencia y legibilidad de múltiples consultas a la base de datos a lo largo del controlador. El propósito principal es simplificar la lógica de filtrado, reemplazar operadores complejos por otros más directos y asegurar la integridad de los datos devueltos.
                    </p>
                    <p>Los cambios clave incluyen:</p>
                    <ul>
                        <li>**Simplificación de Consultas de Estado:** En todas las funciones de sincronización de estado, se ha reemplazado el uso del operador `$or` por el operador `$in` o por una comparación directa. Esto hace que las consultas para encontrar sucursales que necesitan ser abiertas o cerradas sean más limpias, legibles y potencialmente más eficientes.</li>
                        <li>**Mejora en Búsqueda y Exportación:** En las funciones `search` y `exportBranches`, se ha añadido un filtro explícito para excluir las sucursales eliminadas lógicamente (`deletedAt: null`). Además, se ha simplificado la lógica de búsqueda para campos opcionales, utilizando también el operador `$in` para mejorar la claridad del código.</li>
                    </ul>

                    <h4>Cambios Detallados</h4>

                    <h5>1. Simplificación de Lógica de Estado (Reemplazo de `$or` por `$in`)</h5>
                    <p><b>Explicación:</b> En múltiples funciones (`checkOfflinePOSrappi`, `checkOfflinePOSuber`, `checkOfflinePOSpeya`, `enviarEstadoRappi`, `enviarEstadoPedidosYa`), se ha simplificado la lógica para buscar sucursales que necesitan ser abiertas o cerradas. La condición anterior, que usaba `$or` para verificar si un campo existía o tenía un valor específico (ej. `{$exists: false}` o `{$eq: false}`), ha sido reemplazada por el operador `$in` o una comparación directa, que logra el mismo resultado de una manera más concisa.</p>

                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: Se usaba un operador '$or' para buscar sucursales que no estaban marcadas como cerradas.
// ...
    const conditionalOR = [
      { alreadyClosedRappi: { $exists: false } },
      { alreadyClosedRappi: { $eq: false } }
    ];
    // ...
    let branchesToClose = await model.find({
      // ...
      $or: conditionalOR
    });
// ...
                    </code></pre>

                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se reemplaza el '$or' por un operador '$in' más simple y legible.
// ...
    let branchesToClose = await model.find({
      // ...
      // La nueva condición busca documentos donde 'alreadyClosedRappi' sea 'null' o 'false'.
      alreadyClosedRappi: { $in:[null, false] }
    });
// ...
                    </code></pre>

                    <h5>2. Filtro de Eliminados y Simplificación en `search` / `exportBranches`</h5>
                    <p><b>Explicación:</b> En las funciones `search` y `exportBranches`, se ha añadido una etapa `$match: { deletedAt: null }` al inicio del pipeline de agregación. Esto asegura que las búsquedas y exportaciones nunca incluyan sucursales que han sido eliminadas lógicamente. Adicionalmente, se ha simplificado la lógica de filtrado para campos como `agent_version` y `cloud`, reemplazando condiciones `$or` por el operador `$in` para mejorar la legibilidad.</p>

                    <b>Código Anterior:</b>
                    <pre><code class="language-javascript">
// ANTES: La consulta de agregación no filtraba por 'deletedAt' y usaba '$or' para campos opcionales.
// ...
      if (cloudBoolean == 'noCloud')
        dataSearch = { ...dataSearch, ...{ $or: [{ cloud: false }, { cloud: { $exists: false } }] } };
      // ...
      const data = await model
        .aggregate([
          {
            $lookup: { /* ... */ }
          },
          // ...
        ]);
// ...
                    </code></pre>

                    <b>Código Nuevo:</b>
                    <pre><code class="language-javascript">
// DESPUÉS: Se añade el filtro 'deletedAt' y se simplifica la lógica de 'dataSearch'.
// ...
      if (cloudBoolean == 'noCloud')
        // La condición se simplifica usando '$in'.
        dataSearch = { ...dataSearch, ...{ cloud: { $in:  [false, null ] } } };
      // ...
      const data = await model
        .aggregate([
          // Se añade una etapa inicial para excluir documentos eliminados lógicamente.
          { $match: { deletedAt: null } },
          {
            $lookup: { /* ... */ }
          },
          // ...
        ]);
// ...
                    </code></pre>

                    <div class="analysis-box">
                        <h4>Conclusión del análisis</h4>
                        <p>Esta actualización se centra en mejorar la calidad y eficiencia del código de interacción con la base de datos.</p>
                        <ul>
                            <li>**Legibilidad y Mantenibilidad:** El reemplazo del operador `$or` por `$in` en múltiples consultas hace que la intención del código sea mucho más clara y directa, facilitando su mantenimiento futuro.</li>
                            <li>**Integridad de Datos:** La adición del filtro `{ deletedAt: null }` en las funciones de búsqueda y exportación es una mejora crucial que asegura que los usuarios finales solo vean y operen sobre datos activos y relevantes.</li>
                            <li>**Optimización Potencial:** El uso de operadores más simples como `$in` en lugar de `$or` puede, en algunos casos, permitir al motor de la base de datos optimizar mejor la ejecución de la consulta.</li>
                        </ul>
                    </div>
                </div>
            </details>
          
          <details class="component-card">
    <summary class="component-header">
        <h3>api/src/controllers/news.js</h3>
    </summary>
    <div class="component-body">
        <h4>Análisis General</h4>
        <p>
            Esta actualización, como parte de una **Optimización de Consultas de Búsqueda**, refactoriza la función `search` para simplificar y hacer más específicas las consultas a la base de datos. Los cambios se centran en dos áreas principales: la redefinición del campo de búsqueda principal y la simplificación de la lógica de filtrado utilizando operadores de MongoDB más directos.
        </p>
        <p>
            El impacto funcional más significativo es que el campo de búsqueda general (`search`) ahora se enfoca exclusivamente en buscar por el **ID original del pedido (`order.originalId`)**, eliminando la capacidad de buscar por el nombre de la sucursal. Adicionalmente, se han optimizado las consultas para los filtros de "canje" y "cloud", reemplazando operadores `$or` por `$in`, lo que mejora la legibilidad y consistencia del código.
        </p>

        <h4>Cambios Detallados</h4>

        <h5>1. Especialización del Campo de Búsqueda Principal (`search`)</h5>
        <p><b>Explicación:</b> Se ha modificado la lógica del parámetro de búsqueda principal (`search`). Anteriormente, este campo realizaba una búsqueda `$or` que permitía encontrar coincidencias tanto en el nombre de la sucursal (`extraData.branch`) como en el ID del pedido (`order.originalId`). La nueva implementación elimina la búsqueda por nombre de sucursal, haciendo que el campo `search` se utilice únicamente para buscar por `order.originalId`.</p>

        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: La búsqueda principal era ambigua, buscando en dos campos diferentes.
// ...
  const data = {
    ...(search != ''
      ? {
          $or: [
            { 'extraData.branch': new RegExp(search, 'i') },
            { 'order.originalId': search }
          ]
        }
      : {}),
    // ...
  };
// ...
        </code></pre>

        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: La búsqueda principal ahora se enfoca exclusivamente en el ID del pedido.
// ...
  const data = {
    // La condición ahora solo aplica al campo 'order.originalId'.
    ...(search != '' ?  { 'order.originalId': search } : {}),
    // ...
  };
// ...
        </code></pre>

        <h5>2. Simplificación de Lógica de Filtrado (Reemplazo de `$or` por `$in`)</h5>
        <p><b>Explicación:</b> Se han simplificado varias condiciones de filtrado. La lógica para filtrar pedidos "sin canje" (`exchangeBoolean === 'noExchange'`) y sucursales "sin cloud" (`cloudBoolean == 'noCloud'`), que antes usaban un operador `$or` para comprobar múltiples condiciones (como `{$exists: false}`, `0`, `null`), ha sido reemplazada por un operador `$in` más conciso y legible.</p>

        <b>Código Anterior:</b>
        <pre><code class="language-javascript">
// ANTES: Se usaba un operador '$or' para buscar por la ausencia de un valor.
// ...
    ...((exchangeBoolean != 'all' && exchangeBoolean != '') ?
      exchangeBoolean === 'noExchange' ? {
        $or: [
          {'order.details.canje' : { $exists: false }},
          {'order.details.canje' : 0 },
          {'order.details.canje' : null }
        ]
      } : {'order.details.canje' : 1 } : {})
// ...
    const branchQuery = cloudBoolean
      ? { cloud: true }
      : { $or: [{ cloud: false }, { cloud: { $exists: false } }] };
// ...
        </code></pre>

        <b>Código Nuevo:</b>
        <pre><code class="language-javascript">
// DESPUÉS: Se reemplaza el '$or' por un operador '$in' más simple.
// ...
    ...((exchangeBoolean != 'all' && exchangeBoolean != '') ?
      exchangeBoolean === 'noExchange' ? {
        // La nueva condición busca si el campo 'canje' es 'null' o '0'.
        'order.details.canje': {
          $in: [
            null,
            0
          ]
        }
      } : {'order.details.canje' : 1 } : {})
// ...
    const branchQuery = cloudBoolean
      ? { cloud: true }
      // La nueva condición busca si el campo 'cloud' es 'false' o 'null'.
      // Nota: Hay un error tipográfico en el código original ('$cloud' en lugar de 'cloud').
      : { cloud:{ $in :[false, null]} };
// ...
        </code></pre>

        <div class="analysis-box">
            <h4>Conclusión del análisis</h4>
            <p>Las modificaciones en `api/src/controllers/news.js` refinan y especializan la funcionalidad de búsqueda.</p>
            <ul>
                <li>**Búsqueda Específica:** Al limitar el campo `search` a `order.originalId`, la búsqueda se vuelve más predecible y enfocada, eliminando la ambigüedad anterior.</li>
                <li>**Legibilidad del Código:** El reemplazo de operadores `$or` por `$in` mejora la claridad y la mantenibilidad del código de construcción de consultas.</li>
                <li>**Consistencia:** Estos cambios alinean el estilo de las consultas de este controlador con las optimizaciones realizadas en otras partes del sistema (como en `branch.js`), promoviendo un estándar de codificación consistente.</li>
            </ul>
        </div>
    </div>
</details>
            </section>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
