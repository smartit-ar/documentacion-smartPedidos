<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Release: Backoffice 6.2.2</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        /* Importación de Fuentes de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400&display=swap');

        /* Variables CSS para la Paleta de Colores */
        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0056b3;
            --analysis-bg: #e6f7ff;
            --analysis-border: #91d5ff;
            --deployment-bg: #f0fdf4;
            --deployment-border: #86efac;
        }

        /* Estilos Base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2em;
            line-height: 1.7;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Encabezado Principal */
        .main-header {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header h1 {
            margin: 0 0 0.25em 0;
            font-size: 2.2em;
            color: var(--primary-color);
        }

        .main-header p {
            margin: 0;
            font-size: 1.1em;
            color: var(--text-muted-color);
        }

        /* Información de Despliegue */
        .deployment-info-box {
            background-color: var(--deployment-bg);
            border-left: 4px solid var(--deployment-border);
            padding: 1em 1.5em;
            margin-bottom: 2.5em;
            border-radius: 4px;
        }

        .deployment-info-box h4 {
            margin-top: 0;
            font-size: 1.2em;
            color: #166534;
        }

        .deployment-info-box p {
            margin: 0.5em 0 0 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.95em;
        }

        /* Secciones de Servicio */
        .service-section {
            margin-bottom: 3em;
        }

        .service-section>h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* Tarjeta de Componente (details) */
        .component-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Encabezado de la Tarjeta (summary) */
        .component-header {
            padding: 1em 1.5em;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            list-style: none; /* Oculta el marcador de triángulo por defecto */
        }

        /* Oculta el marcador de triángulo en WebKit (Chrome/Safari) */
        .component-header::-webkit-details-marker {
            display: none;
        }

        .component-header h3 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.2em;
        }

        /* Cuerpo de la Tarjeta */
        .component-body {
            padding: 1.5em;
        }

        .component-body h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #343a40;
        }

        .component-body h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
            font-weight: 700;
        }

        /* Caja de Conclusión del Análisis */
        .analysis-box {
            background-color: var(--analysis-bg);
            border-left: 4px solid var(--analysis-border);
            padding: 1em 1.5em;
            margin-top: 1.5em;
            border-radius: 4px;
        }

        .analysis-box h4 {
            margin-top: 0;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        /* Bloques de Código (Prism.js) */
        pre[class*="language-"] {
            padding: 1.2em !important;
            margin: 1em 0 !important;
            border-radius: 6px;
            font-family: 'Fira Code', monospace !important;
            font-size: 0.9em !important;
            line-height: 1.5 !important;
            border: 1px solid var(--border-color);
            /* CRÍTICO: Ajuste de código para evitar el scroll horizontal */
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="main-header">
            <h1>Notas de Release: Backoffice 6.2.2</h1>
            <p>
                Reingeniería de visualización de pedidos y soporte para estructuras de datos complejas.
            </p>
        </header>

        <div class="deployment-info-box">
            <h4>Información de Despliegue</h4>
            <p><b>Versión:</b> 6.2.2</p>
            <p><b>Fecha de Despliegue:</b> 2025-12-16</p>
            <p><b>Commits:</b> 37ae5e96a8de73b7a60cb1886e2f9a066ceae74c</p>
        </div>

        <section id="summary" class="service-section">
            <h2>Resumen General de la Versión</h2>
            <p>
                Esta actualización introduce una lógica de negocio avanzada y un rediseño completo de la interfaz de "Status" en el Dashboard. Se implementa un sistema de visualización dual capaz de manejar tanto pedidos antiguos como nuevas estructuras jerárquicas (combos, extras, opcionales). El sistema ahora calcula recursivamente los precios acumulados para garantizar precisión financiera y ofrece controles de expansión para mejorar la usabilidad.
            </p>
        </section>

        <section id="technical-analysis" class="service-section">
            <h2>Análisis Técnico Detallado</h2>

            <!-- Bloque para app/src/app/pages/dashboard/status/status.component.ts -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>app/src/app/pages/dashboard/status/status.component.ts</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    El componente ahora pre-procesa los datos de la orden para adaptarse dinámicamente a dos estructuras posibles. El cambio más significativo es el cálculo programático de precios acumulados (<code>totalAcum</code>), recorriendo recursivamente la jerarquía del pedido.
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Gestión de Estado de Visualización y Compatibilidad</h5>
                  <p><b>Explicación:</b> Se introducen banderas de estado (<code>otherMapper</code>, <code>expanD</code>) y una función utilitaria. <code>otherMapper</code> actúa como un "feature flag" dinámico para el renderizado, mientras que <code>expanCompresF</code> permite controlar la expansión global de los detalles.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-typescript">
// ANTES: Variables de estado limitadas a fechas y países
  minDate: string;
  maxDate: string;
  dateSelected: string;
  // ...
  // No existía lógica de expansión global
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-typescript">
// DESPUÉS: Banderas para controlar el modo de mapeo y la expansión de UI
  dateSelected: string;
  otherMapper = false; // Indica si se usa la nueva estructura de datos
  expanD = false;      // Estado global de expansión

  // ...

  // Método para alternar la visibilidad de sub-detalles en toda la orden
  expanCompresF(){
    this.expanD = !this.expanD;
    // Recorre y fuerza la propiedad 'show' en todos los detalles y sub-ítems
    if(this.expanD) { 
      this.selectedNew.order.details = this.selectedNew.order.details.map(detail => {
        // ... lógica para setear show: true ...
      });
    } else {
      // ... lógica para setear show: false ...
    }
  }
                  </code></pre>
            
                  <h5>Lógica de Cálculo de Precios Acumulados (totalAcum)</h5>
                  <p><b>Explicación:</b> Se inyecta un bloque de procesamiento que detecta si la orden tiene la estructura nueva. Si es así, realiza una suma recursiva de precios (Base + Incluidos + Extras) y almacena el resultado en <code>totalAcum</code>.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-typescript">
// ANTES: Se asignaba el resultado directamente sin procesar detalles profundos
    this._dashboardService.getNew(id).subscribe((result) => {
      console.log("?", result);
      this.selectedNew = result;
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-typescript">
// DESPUÉS: Pre-procesamiento exhaustivo para calcular totales precisos
    this._dashboardService.getNew(id).subscribe((result) => {
      console.log("?", result);
      // Detección de estructura nueva
      if (result.order.details.some(d => d.itemId)) {
        this.otherMapper = true;
        // Iteración para cálculo financiero
        result.order.details = result.order.details.map(detail => {   
          detail.totalAcum = detail.quantity * detail.price; // Base
          
          // Sumar costos de ítems incluidos (combos)
          if(detail.includedItems)
          for (const element of detail.includedItems) {
            if(element.price > 0) detail.totalAcum+= (element.price*element.quantity);
            // ... sumar extras dentro del combo ...
          }
          
          // Sumar costos de extras del ítem principal
          if(detail.customizations && detail.customizations.extras)
          for (const element of detail.customizations.extras) {
            if(element.price > 0) detail.totalAcum+= (element.price*element.quantity);
          }
          
          return { ...detail, show: false }; // Estado inicial colapsado
        });
      } else{
         this.otherMapper = false; // Fallback a vista legacy
      }
      this.selectedNew = result;
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Adaptabilidad:</b> El componente es polimórfico, manejando pedidos legacy y modernos simultáneamente.<br>
                  <b>Integridad Financiera:</b> Centraliza el cálculo de costos complejos en el controlador, eliminando discrepancias visuales.<br>
                  <b>UX:</b> Transforma una lista plana en una vista jerárquica y ordenable.</p>
                </div>
              </div>
            </details>
            
            <!-- Bloque para app/src/app/pages/dashboard/status/status.component.html -->
            <details class="component-card" open>
              <summary class="component-header">
                <h3>app/src/app/pages/dashboard/status/status.component.html</h3>
              </summary>
              <div class="component-body">
                  <h4>Análisis General</h4>
                  <p>
                    Reingeniería completa de la sección "Detalles". Se implementa una vista dual activada por la bandera <code>otherMapper</code>, diseñada para renderizar pedidos jerárquicos con controles de acordeón y distintivos visuales (badges).
                  </p>
                  
                  <h4>Cambios Detallados</h4>
            
                  <h5>Implementación de Vista Condicional y Controles Globales</h5>
                  <p><b>Explicación:</b> Se encapsula la tabla antigua y se crea una nueva estructura condicional. Se añade un botón global para expandir/colapsar todos los detalles del pedido.</p>
                  <b>Código Anterior:</b>
                  <pre><code class="language-html">
<!-- ANTES: Estructura plana y única -->
          <h6 class="mt-3"><strong>Detalles</strong></h6>
          <div class="table-responsive">
            <table class="table table-sm">
               <!-- Tabla única para todos los casos -->
                  </code></pre>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-html">
<!-- DESPUÉS: Cabecera con controles y renderizado condicional -->
          <div class="row" >
            <h6 class="mt-3 col-11"><strong>Detalles</strong></h6>  
            <div *ngIf="otherMapper" class="mb-2">
              <button title="Expandir detalles" (click)="expanCompresF()" ... ></button>
            </div>
          </div>
       
          <!-- Vista Nueva (Jerárquica) -->
          <div class="table-responsive rounded"  *ngIf="otherMapper">
             <!-- ... nueva tabla compleja ... -->
          </div>          

          <!-- Vista Legacy (Plana) -->
          <div class="table-responsive" *ngIf="!otherMapper">
             <!-- ... tabla antigua ... -->
          </div>
                  </code></pre>
            
                  <h5>Renderizado Jerárquico y Distinción Visual (Badges)</h5>
                  <p><b>Explicación:</b> La nueva tabla soporta anidamiento. Se clasifican los componentes visualmente: Badge Verde (Extra), Azul (Incluye), Rojo (Opcional/Removido).</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-html">
<!-- DESPUÉS: Ejemplo de lógica visual para Extras vs Opcionales -->
                    <ng-container *ngFor="let item of detail?.customizations?.extras">
                      <tr *ngIf="item.price > 0" class="bg-light">  
                        <!-- ... -->
                        <td class="font-weight-bold">
                          <span class="badge badge-success">Extra</span>{{' '+item.itemDescription}}  
                        </td>
                        <!-- ... -->
                      </tr>
                      <tr *ngIf="!(item.price > 0)" class="bg-light">  
                        <!-- ... -->
                        <td class="font-weight-bold">
                          <span class="badge badge-danger">Opcional</span>{{' '+item.itemDescription}}  
                        </td>   
                        <!-- ... -->
                      </tr>
                    </ng-container>
                  </code></pre>

                  <h5>Desglose Financiero Explícito</h5>
                  <p><b>Explicación:</b> Se añaden filas dedicadas para mostrar el desglose de Envío, Subtotal, Descuento y Total, utilizando el objeto <code>payment</code>.</p>
                  <b>Código Nuevo:</b>
                  <pre><code class="language-html">
<!-- DESPUÉS: Footer de la tabla con totales -->
                  <tr>
                    <td colspan="4" class="text-right border-top..."><strong>Envío</strong></td>
                    <td class="border-top..."><strong class="text-success">+{{ ...shipping }}</strong></td>
                  </tr>
                  <!-- ... Subtotal ... -->
                  <tr>
                    <td colspan="4" class="text-right border-0..."><strong>Descuento</strong></td>
                    <td class="border-0..."><strong class="text-danger">-{{ ...discount }}</strong></td>
                  </tr>
                  <tr class="h5">
                    <td colspan="4" class="text-right..."><strong>Total</strong></td>
                    <td><strong>{{ ...totalAmount }}</strong></td>
                  </tr>
                  </code></pre>
                  
                  <div class="analysis-box">
                  <h4>Conclusión del análisis</h4>
                  <p><b>Claridad Operativa:</b> Permite revisar pedidos complejos sin perder contexto mediante controles de expansión.<br>
                  <b>Precisión:</b> Refleja fielmente la estructura del backend, mostrando explícitamente cargos y descuentos.<br>
                  <b>Robustez:</b> Mantiene compatibilidad con integraciones antiguas mientras habilita la nueva experiencia.</p>
                </div>
              </div>
            </details>

        </section>
    </div>

    <!-- Scripts de Prism.js para resaltar código -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

</body>
</html>
